<!-- Developed by Wilhem Jeldes, MS for Wanda Winter of TotalEnergies. May, 2025. -->
<!-- Ver7: Refactored for broad browser compatibility -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario y Ruleta para Evento - Ver7 Refactored</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 100%;
        }

        .header {
            background-color: #ff0000;
            color: white;
            text-align: center;
            padding: 15px 20px;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            max-height: 80px;
            max-width: 300px;
            object-fit: contain;
            margin-right: 15px;
        }

        .header-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .robot-quartz-gif {
            height: 60px;
            margin-left: 15px;
        }

        .header-buttons {
            display: flex;
            align-items: center;
        }

        .header-buttons > .admin-toggle-btn:not(:first-child) {
            margin-left: 15px;
        }

        .admin-toggle-btn {
            background-color: #285aff;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            -webkit-transition: background-color 0.3s, -webkit-transform 0.2s;
            transition: background-color 0.3s, transform 0.2s;
        }

        .admin-toggle-btn.active {
            background-color: #ff0000;
            -webkit-transform: scale(1.05);
            transform: scale(1.05);
        }

        .wheel-only-button {
            background-color: white;
            border: 2px solid #28c896;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            -webkit-transition: -webkit-transform 0.3s, box-shadow 0.3s;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            padding: 0;
        }

        .wheel-icon {
            width: 35px;
            height: 35px;
            object-fit: contain;
            -webkit-transition: -webkit-transform 0.3s;
            transition: transform 0.3s;
        }

        .wheel-only-button.form-mode .wheel-icon {
            -webkit-transform: rotate(180deg);
            transform: rotate(180deg);
        }

        .wheel-only-button:hover {
            -webkit-transform: rotate(20deg);
            transform: rotate(20deg);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        .admin-toggle-btn:hover {
            opacity: 0.9;
        }

        .content {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-section {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative;
        }

        .form-section::before, .form-section::after {
            content: '';
            position: absolute;
            width: 150px;
            height: 300px;
            background-image: url('TA6-totalenergies-quartz-extra-1.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
            top: 50%;
            -webkit-transform: translateY(-50%);
            transform: translateY(-50%);
        }

        .form-section::before {
            left: -160px;
        }

        .form-section::after {
            right: -160px;
        }

        .form-inner {
            background: rgba(255, 255, 255, 0.92);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            position: relative;
            z-index: 1;
        }

        .admin-section {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            display: none;
        }

        .admin-section h3 {
            color: #ff0000;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 2px solid #ff0000;
            padding-bottom: 5px;
        }

        .form-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #ff0000;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 18px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            -webkit-transition: border-color 0.3s;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #285aff;
            outline: none;
        }

        input[type="color"] {
            padding: 5px;
            height: 40px;
        }

        .btn {
            background-color: #285aff;
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            -webkit-transition: background-color 0.3s;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:active {
            -webkit-transform: scale(0.98);
            transform: scale(0.98);
        }

        .wheel-section {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background-color: white;
        }

        .wheel-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 30px auto;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            padding: 10px;
        }

        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            -webkit-transition: -webkit-transform 7s cubic-bezier(0.25, 0.1, 0.25, 1);
            transition: transform 7s cubic-bezier(0.25, 0.1, 0.25, 1);
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
            box-shadow: 0 0 20px rgba(0,0,0,0.3), inset 0 0 10px rgba(0,0,0,0.2);
        }

        .wheel-indicator {
            position: absolute;
            top: -15px;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #ff0000;
            z-index: 10;
        }

        .spin-button {
            background-color: #28c896;
            margin-top: 30px;
            width: 200px;
        }

        .logo-below-wheel {
            margin-top: 30px;
            margin-bottom: 20px;
            width: 200px;
        }

        #result {
            text-align: center;
            margin-top: 30px;
            font-size: 30px;
            font-weight: bold;
            color: #ff0000;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 80%;
            width: 500px;
            position: relative;
            -webkit-animation: popup 0.5s;
            animation: popup 0.5s;
        }

        @-webkit-keyframes popup {
            0% { -webkit-transform: scale(0.7); opacity: 0; }
            100% { -webkit-transform: scale(1); opacity: 1; }
        }

        @keyframes popup {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .firework-particle {
            position: fixed;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            z-index: 1001;
            pointer-events: none;
            -webkit-animation: explodeAndFall 2s ease-out forwards;
            animation: explodeAndFall 2s ease-out forwards;
            -webkit-animation-iteration-count: 2;
            animation-iteration-count: 2;
        }

        @-webkit-keyframes explodeAndFall {
            0% {
                -webkit-transform: translate(0, 0) scale(0.3);
                transform: translate(0, 0) scale(0.3);
                opacity: 1;
            }
            30% {
                -webkit-transform: translate(var(--translateX), var(--translateY)) scale(1);
                transform: translate(var(--translateX), var(--translateY)) scale(1);
                opacity: 1;
            }
            100% {
                -webkit-transform: translate(var(--translateX), calc(var(--translateY) + 70px)) scale(0);
                transform: translate(var(--translateX), calc(var(--translateY) + 70px)) scale(0);
                opacity: 0;
            }
        }

        @keyframes explodeAndFall {
            0% {
                transform: translate(0, 0) scale(0.3);
                opacity: 1;
            }
            30% {
                transform: translate(var(--translateX), var(--translateY)) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--translateX), calc(var(--translateY) + 70px)) scale(0);
                opacity: 0;
            }
        }

        .prize-title {
            color: #ff0000;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .prize-text {
            font-size: 24px;
            margin-bottom: 30px;
        }

        .close-modal {
            margin-top: 20px;
            background-color: #28c896;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            -webkit-animation-name: confetti-fall;
            animation-name: confetti-fall;
            -webkit-animation-timing-function: ease-in-out;
            animation-timing-function: ease-in-out;
            -webkit-animation-fill-mode: forwards;
            animation-fill-mode: forwards;
            z-index: 999;
        }

        @-webkit-keyframes confetti-fall {
            0% { -webkit-transform: translateY(-100vh) rotate(0deg); transform: translateY(-100vh) rotate(0deg); }
            100% { -webkit-transform: translateY(100vh) rotate(720deg); transform: translateY(100vh) rotate(720deg); }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(720deg); }
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .admin-table th, .admin-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 16px;
        }
        .admin-table th {
            background-color: #f2f2f2;
            color: #333;
        }
        .admin-table .action-btn {
            padding: 6px 10px;
            font-size: 14px;
            margin-right: 5px;
        }

        @media (min-width: 1921px) {
            .header {
                font-size: 36px;
                padding: 20px 30px;
            }
            .form-title {
                font-size: 30px;
            }
            .btn {
                padding: 20px 25px;
                font-size: 22px;
            }
        }

        @media (max-width: 320px) {
            .wheel-container {
                width: 95vw;
                height: 95vw;
                max-width: 280px;
                min-width: 240px;
                min-height: 240px;
            }

            #spinBtn {
                font-size: 12px;
                padding: 6px 12px;
                min-height: 44px;
                min-width: 88px;
            }

            .header {
                font-size: 18px;
                padding: 10px 15px;
            }

            .header-logo {
                max-height: 35px;
            }

            .form-section, .admin-section {
                padding: 15px;
                margin: 10px;
            }
        }

        @media (min-width: 321px) and (max-width: 480px) {
            .wheel-container {
                width: 90vw;
                height: 90vw;
                max-width: 350px;
                min-width: 280px;
                min-height: 280px;
            }

            #spinBtn {
                font-size: 14px;
                padding: 8px 16px;
                min-height: 44px;
                min-width: 100px;
            }

            .header {
                font-size: 20px;
            }

            .header-logo {
                max-height: 40px;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .wheel-container {
                width: 85vw;
                height: 85vw;
                max-width: 500px;
                min-width: 350px;
                min-height: 350px;
            }

            #spinBtn {
                font-size: 16px;
                padding: 10px 20px;
                min-height: 48px;
                min-width: 120px;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .wheel-container {
                width: 70vw;
                height: 70vw;
                max-width: 600px;
                min-width: 400px;
                min-height: 400px;
            }

            #spinBtn {
                font-size: 18px;
                padding: 12px 24px;
                min-height: 50px;
                min-width: 140px;
            }
        }

        @media (min-width: 1201px) and (max-width: 1600px) {
            .wheel-container {
                width: 60vw;
                height: 60vw;
                max-width: 700px;
                min-width: 500px;
                min-height: 500px;
            }
        }

        @media (min-width: 1601px) {
            .wheel-container {
                width: 50vw;
                height: 50vw;
                max-width: 800px;
                min-width: 600px;
                min-height: 600px;
            }
        }

        .btn, .admin-toggle-btn, .wheel-only-button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 16px;
            }

            .admin-toggle-btn, .wheel-only-button {
                min-width: 44px;
                min-height: 44px;
            }
        }

        @media (orientation: portrait) {
            .container {
                max-width: 100%;
                width: 100%;
            }
            .header {
                font-size: 22px;
            }
            .header-logo {
                max-height: 40px;
            }
            .admin-toggle-btn {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        .password-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .password-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .password-modal-content h3 {
            color: #ff0000;
            margin-bottom: 20px;
        }

        .password-modal-content input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .password-modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .password-modal-submit {
            background-color: #285aff;
            color: white;
        }

        .password-modal-cancel {
            background-color: #ccc;
            color: #333;
        }

        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            -webkit-transform: translateX(100%);
            transform: translateX(100%);
            -webkit-transition: all 0.5s ease;
            transition: all 0.5s ease;
            font-size: 16px;
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            -webkit-transform: translateX(0);
            transform: translateX(0);
        }

        .toast.error {
            background-color: #e74c3c;
        }

        .toast.warning {
            background-color: #f39c12;
        }

        .toast.success {
            background-color: #2ecc71;
        }
    </style>
</head>
<body>
    <div id="toastContainer"></div>
    <div class="container">        <div class="header">
            <img src="Quartz Banner.png" alt="Quartz Banner" id="companyLogo" class="header-logo">
            <div class="header-center">
                <span id="headerTitle">TotalEnergies Quartz - Ruleta de Premios</span>
                <img src="Robotquartz-TotalEnergies.gif" alt="RobotQuartz GIF" class="robot-quartz-gif">
            </div>            <div class="header-buttons">
                <button id="adminToggleBtn" class="admin-toggle-btn">AP</button>
                <button id="wheelOnlyBtn" class="admin-toggle-btn" title="Solo mostrar la ruleta">Wh</button>
            </div>
        </div>

        <div class="content">
            <div id="formSection" class="form-section">
                <div class="form-inner">
                    <h2 class="form-title">Ingresa tus datos para participar</h2>
                    <form id="participantForm">
                        <div class="form-group">
                            <label for="name">Nombre completo</label>
                            <input type="text" id="name" name="name" required>
                        </div>

                        <div class="form-group">
                            <label for="email">Correo electrónico</label>
                            <input type="email" id="email" name="email" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">Teléfono</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                          <div class="form-group">
                            <input type="checkbox" id="subscribe" name="subscribe" style="width: auto; margin-right: 10px; vertical-align: middle;">
                            <label for="subscribe" style="display: inline; font-weight: normal; font-size: 16px;">Acepto recibir comunicaciones comerciales, promociones y ofertas personalizadas por medios electrónicos.</label>
                            <p style="font-size: 12px; color: #777; margin-top: 10px;">Los datos personales proporcionados serán tratados por TotalEnergies Marketing Puerto Rico Corp. con la finalidad de gestionar su solicitud. Puede ejercer sus derechos de acceso, rectificación, supresión y otros, según se detalla en nuestra Política de Privacidad.</p>
                        </div>

                        <button type="submit" class="btn">¡Participar ahora!</button>
                    </form>
                </div>
            </div>

            <div id="wheelSection" class="wheel-section">
                <h2 class="form-title">¡Gira la Ruleta y Descubre Tu Premio!</h2>

                <div class="wheel-container">
                    <div class="wheel-indicator"></div>
                    <canvas id="wheel"></canvas>
                </div>

                <button id="spinBtn" class="btn spin-button">¡GIRAR!</button>

                <div id="result"></div>

                <img src="TotalEnergies_Logo_RGB_32.png" alt="TotalEnergies Logo" class="logo-below-wheel">
            </div>            <div id="adminSection" class="admin-section">
                <h2 class="form-title">Panel de Administración</h2>

                <h3>Configuración de Imágenes</h3>
                <div class="form-group">
                    <label for="adminHeaderImageFile">Imagen del Header (Quartz Banner)</label>
                    <input type="file" id="adminHeaderImageFile" accept="image/*">
                    <small style="color: #666; display: block; margin-top: 5px;">Imagen actual: Quartz Banner.png</small>
                </div>
                <div class="form-group">
                    <label for="adminGifImageFile">Imagen GIF Animada (Robot Quartz)</label>
                    <input type="file" id="adminGifImageFile" accept="image/*">
                    <small style="color: #666; display: block; margin-top: 5px;">Imagen actual: Robotquartz-TotalEnergies.gif</small>
                </div>
                <div class="form-group">
                    <label for="adminCenterLogoFile">Logo del Centro de la Ruleta</label>
                    <input type="file" id="adminCenterLogoFile" accept="image/*">
                    <small style="color: #666; display: block; margin-top: 5px;">Logo actual del centro de la ruleta</small>
                </div>

                <h3>Configuración General</h3>
                <div class="form-group">
                    <label for="adminCompanyLogoFile">URL Logo Empresa (Header) - Método Anterior</label>
                    <input type="file" id="adminCompanyLogoFile" accept="image/*">
                    <small style="color: #666; display: block; margin-top: 5px;">Método alternativo para cargar logo</small>
                </div>
                <div class="form-group">
                    <label for="adminRouletteLogoFile">URL Logo Centro Ruleta - Método Anterior</label>
                    <input type="file" id="adminRouletteLogoFile" accept="image/*">
                    <small style="color: #666; display: block; margin-top: 5px;">Método alternativo para logo central</small>
                </div>
                <button id="saveAdminSettingsBtn" class="btn">Guardar Configuración</button>

                <h3>Personalización de la Ruleta</h3>
                <div class="form-group">
                    <label for="adminWheelSize">Tamaño de la Ruleta (%)</label>
                    <input type="range" id="adminWheelSize" min="50" max="150" value="100" step="5">
                    <span id="wheelSizeValue">100%</span>
                </div>
                <div class="form-group">
                    <label for="adminWheelBorderWidth">Grosor del Borde</label>
                    <input type="range" id="adminWheelBorderWidth" min="0" max="20" value="10" step="1">
                    <span id="borderWidthValue">10px</span>
                </div>
                <div class="form-group">
                    <label for="adminWheelBorderColor">Color del Borde</label>
                    <input type="color" id="adminWheelBorderColor" value="#ffffff">
                </div>
                <div class="form-group">
                    <label for="adminWheelBgOpacity">Transparencia del Fondo (%)</label>
                    <input type="range" id="adminWheelBgOpacity" min="0" max="100" value="70" step="5">
                    <span id="bgOpacityValue">70%</span>
                </div>
                <div class="form-group">
                    <label for="adminPointerColor">Color del Indicador</label>
                    <input type="color" id="adminPointerColor" value="#ff0000">
                </div>
                <div class="form-group">
                    <label for="adminTextSize">Tamaño del Texto (%)</label>
                    <input type="range" id="adminTextSize" min="50" max="200" value="100" step="10">
                    <span id="textSizeValue">100%</span>
                </div>
                <button id="applyWheelCustomization" class="btn" style="background-color: #4CAF50;">Aplicar Personalización</button>
                <button id="resetWheelDefaults" class="btn" style="background-color: #FF5722;">Restablecer Valores por Defecto</button>

                <h3>Gestión de Premios</h3>
                <form id="prizeForm">
                    <div class="form-group">
                        <label for="prizeTextAdmin">Nombre del Premio</label>
                        <input type="text" id="prizeTextAdmin" required>
                    </div>
                    <div class="form-group">
                        <label for="prizeColorAdmin">Color del Segmento</label>
                        <input type="color" id="prizeColorAdmin" value="#ff0000" required>
                    </div>
                    <div class="form-group">
                        <label for="prizeProbabilityAdmin">Probabilidad (peso)</label>
                        <input type="number" id="prizeProbabilityAdmin" min="1" value="10" required>
                    </div>
                    <div class="form-group">
                        <label for="prizeQuantityAdmin">Cantidad Disponible (0 para ilimitado)</label>
                        <input type="number" id="prizeQuantityAdmin" min="0" value="10" required>
                    </div>
                    <input type="hidden" id="prizeEditIndex">
                    <button type="submit" class="btn">Añadir/Actualizar Premio</button>
                </form>
                <h4>Listado de Premios</h4>
                <table id="prizesTable" class="admin-table">
                    <thead>
                        <tr>
                            <th>Premio</th>
                            <th>Color</th>
                            <th>Probabilidad</th>
                            <th>Cantidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <h3>Datos de Participantes</h3>
                <table id="participantsTable" class="admin-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Desea Recibir Información</th>
                            <th>Fecha</th>
                            <th>Premio Ganado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button id="exportCsvBtn" class="btn">Exportar a CSV</button>
                <button id="resetPrizesQuantityBtn" class="btn" style="background-color: #ff9800;">Resetear Cantidad Premios</button>
                <button id="clearParticipantsBtn" class="btn" style="background-color: #f44336;">Limpiar Participantes</button>
            </div>
        </div>
    </div>

    <div id="prizeModal" class="modal">
        <div class="modal-content">
            <h2 class="prize-title">¡Felicidades!</h2>
            <p id="prizeModalText" class="prize-text">Has ganado un premio increíble</p>
            <button id="closeModal" class="btn close-modal">Aceptar</button>
        </div>
    </div>

    <div id="passwordAdminModal" class="password-modal">
        <div class="password-modal-content">
            <h3>Acceso Administrador</h3>
            <label for="adminPasswordInput" style="display:block; margin-bottom:8px;">Contraseña:</label>
            <input type="password" id="adminPasswordInput">
            <div class="password-modal-buttons">
                <button id="submitAdminPassword" class="password-modal-submit">Ingresar</button>
                <button id="cancelAdminPassword" class="password-modal-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        var participants = [];
        var prizes = [];

        // Roulette variables
        var canvasWheel, ctxWheel, wheelRadius, wheelCenterX, wheelCenterY, wheelSize;
        var isSpinning = false;
        var startAngle = 0;
        var currentRotationDegrees = 0;
        var targetRotationDegrees = 0;
        var selectedPrizeIndex = null;
        var rouletteCenterLogoImg = null;

        // Predefined wheel color scheme
        var wheelColors = ["#ff0000", "#285aff", "#009bff", "#32c8c8", "#28c896", "#808080", "#ffc800"]; // Updated dark gray for "Suerte en la próxima"

        var defaultPrizes = [
            { text: "¡Cambio de aceite Quartz gratis!", color: "#ff0000", probability: 10, quantity: 5, initialQuantity: 5 },
            { text: "¡Suerte en la próxima!", color: "#808080", probability: 20, quantity: 0, initialQuantity: 0 },
            { text: "US$20.00 de Combustible TE!", color: "#009bff", probability: 15, quantity: 10, initialQuantity: 10 },
            { text: "¡Gorra Quartz!", color: "#32c8c8", probability: 10, quantity: 15, initialQuantity: 15 },
            { text: "¡Camiseta Quartz!", color: "#28c896", probability: 10, quantity: 15, initialQuantity: 15 },
            { text: "US$50.00 de Combustible TE!", color: "#96e600", probability: 5, quantity: 5, initialQuantity: 5 },
            { text: "4 cuartos de Quartz!", color: "#ffc800", probability: 10, quantity: 10, initialQuantity: 10 },
            { text: "¡$US100.00 TE Gift Card!", color: "#285aff", probability: 5, quantity: 3, initialQuantity: 3 }
        ];

        // DOM Elements
        var participantForm = document.getElementById('participantForm');
        var formSection = document.getElementById('formSection');
        var wheelSection = document.getElementById('wheelSection');
        var spinBtn = document.getElementById('spinBtn');
        var resultDiv = document.getElementById('result');
        var prizeModal = document.getElementById('prizeModal');
        var prizeModalText = document.getElementById('prizeModalText');
        var closeModalBtn = document.getElementById('closeModal');

        var adminToggleBtn = document.getElementById('adminToggleBtn');
        var adminSection = document.getElementById('adminSection');
        var passwordAdminModal = document.getElementById('passwordAdminModal');
        var adminPasswordInput = document.getElementById('adminPasswordInput');
        var submitAdminPasswordBtn = document.getElementById('submitAdminPassword');
        var cancelAdminPasswordBtn = document.getElementById('cancelAdminPassword');
        var wheelOnlyBtn = document.getElementById('wheelOnlyBtn');

        var adminCompanyLogoFileInput;
        var adminRouletteLogoFileInput;

        var saveAdminSettingsBtn = document.getElementById('saveAdminSettingsBtn');
        var companyLogoElement = document.getElementById('companyLogo');

        var prizeForm = document.getElementById('prizeForm');
        var prizeTextAdminInput = document.getElementById('prizeTextAdmin');
        var prizeColorAdminInput = document.getElementById('prizeColorAdmin');
        var prizeProbabilityAdminInput = document.getElementById('prizeProbabilityAdmin');
        var prizeQuantityAdminInput = document.getElementById('prizeQuantityAdmin');
        var prizeEditIndexInput = document.getElementById('prizeEditIndex');
        var prizesTableBody = document.getElementById('prizesTable').getElementsByTagName('tbody')[0];

        var participantsTableBody = document.getElementById('participantsTable').getElementsByTagName('tbody')[0];
        var exportCsvBtn = document.getElementById('exportCsvBtn');
        var resetPrizesQuantityBtn = document.getElementById('resetPrizesQuantityBtn');
        var clearParticipantsBtn = document.getElementById('clearParticipantsBtn');

        // Idle timer variables
        var idleTimer = null;
        var IDLE_TIMEOUT_MS = 180000; // 3 minutes

        // Utility function for debouncing
        function debounce(func, delay) {
            var timeout;
            return function() {
                var context = this;
                var args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, delay);
            };
        }

        // Toast Notification Function
        function showToast(message, type) {
            if (type === undefined) {
                type = 'success';
            }
            var container = document.getElementById('toastContainer');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(function() {
                toast.classList.add('show');
            }, 100);

            setTimeout(function() {
                toast.classList.remove('show');
                setTimeout(function() {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 500);
            }, 3000);
        }

        // Global state variables
        var isWheelOnlyModeActive = false;
        var formSectionDisplayBeforeAdmin = 'block'; // Default initial state for form
        var wheelSectionDisplayBeforeAdmin = 'none'; // Default initial state for wheel

        // Setup listeners for idle detection
        function setupIdleListeners() {
            var events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];

            events.forEach(function(event) {
                document.addEventListener(event, resetIdleTimer, { passive: true });
            });

            resetIdleTimer();
        }

        // Reset the idle timer
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(function() {
                var formSection = document.getElementById('formSection');

                if (formSection.style.display === 'none') {
                    showToast('Reiniciando por inactividad...', 'warning');
                    setTimeout(function() {
                        resetForm();
                        if (isSpinning) {
                            isSpinning = false;
                            if (canvasWheel) {
                                canvasWheel.style.transition = 'none';
                            }
                        }
                        formSection.style.display = 'block';
                        var wheelOnlyBtn = document.getElementById('wheelOnlyBtn');
                        if (wheelOnlyBtn) {
                            wheelOnlyBtn.classList.remove('form-mode');
                        }

                        var wheelSection = document.getElementById('wheelSection');
                        if (wheelSection) {
                            wheelSection.style.display = 'none';
                        }
                          setTimeout(function() {
                            if (typeof resizeWheel === 'function') {
                                resizeWheel();
                            }
                            if (typeof drawWheel === 'function') {
                                drawWheel();
                            }
                        }, window.innerWidth <= 768 ? 150 : 100);
                    }, 1500);
                }
            }, IDLE_TIMEOUT_MS);
        }

        // Initial listeners setup
        window.addEventListener('DOMContentLoaded', function() {
            // Set up image upload event listeners
            var adminCompanyLogoFileInput = document.getElementById('adminCompanyLogoFile');
            var adminRouletteLogoFileInput = document.getElementById('adminRouletteLogoFile');
            var adminHeaderImageFileInput = document.getElementById('adminHeaderImageFile');
            var adminGifImageFileInput = document.getElementById('adminGifImageFile');
            var adminCenterLogoFileInput = document.getElementById('adminCenterLogoFile');

            // Add change listeners for file inputs
            if (adminCompanyLogoFileInput) {
                adminCompanyLogoFileInput.addEventListener('change', handleCompanyLogoUpload);
            }
            if (adminRouletteLogoFileInput) {
                adminRouletteLogoFileInput.addEventListener('change', handleRouletteLogoUpload);
            }
            if (adminHeaderImageFileInput) {
                adminHeaderImageFileInput.addEventListener('change', handleCompanyLogoUpload);
            }
            if (adminGifImageFileInput) {
                adminGifImageFileInput.addEventListener('change', handleCompanyLogoUpload);
            }
            if (adminCenterLogoFileInput) {
                adminCenterLogoFileInput.addEventListener('change', handleRouletteLogoUpload);
            }

            // Set up wheel customization event listeners
            setupWheelCustomizationListeners();

            // Load saved wheel customization settings
            loadWheelCustomizationSettings();

            loadPrizes(); // Load prizes first
            loadParticipants(); // Load participants

            initWheel(); // Initialize the wheel mechanics and drawing

            if (spinBtn) { // Add event listener for the spin button
                spinBtn.addEventListener('click', spinWheel);
            } else {
                console.error("Spin button not found. Spin functionality will not work.");
            }

            // Set initial view states
            if (formSection) formSection.style.display = 'block';
            if (wheelSection) wheelSection.style.display = 'none';
            if (adminSection) adminSection.style.display = 'none';

            renderPrizesTable(); // Populate admin prizes table
            renderParticipantsTable(); // Populate admin participants table

            isWheelOnlyModeActive = false; // Explicitly set initial mode
            if (wheelOnlyBtn) { // Assumes wheelOnlyBtn is defined
                wheelOnlyBtn.classList.remove('active');
                wheelOnlyBtn.addEventListener('click', toggleWheelOnlyMode);
            } else {
                console.warn('"wheelOnlyBtn" not found. The "Wh" button may not work.');
            }

            setupIdleListeners(); // Setup existing idle listeners
            resetIdleTimer();     // Start/reset the idle timer
        });

        closeModalBtn.addEventListener('click', function() {
            prizeModal.style.display = 'none';
            resetForm(); // Return to the form screen
        });

        // Function to toggle between form and wheel-only modes
        function toggleWheelOnlyMode() {
            resetIdleTimer();
            if (!formSection || !wheelSection || !adminSection) {
                console.error("Form, Wheel, or Admin section not found for toggleWheelOnlyMode.");
                return;
            }

            if (isWheelOnlyModeActive) {
                // Switch back to form mode (default view)
                formSection.style.display = 'block';
                wheelSection.style.display = 'none';
                adminSection.style.display = 'none'; // Ensure admin is hidden
                isWheelOnlyModeActive = false;
                if (wheelOnlyBtn) wheelOnlyBtn.classList.remove('active');
                // No need to redraw wheel if it's hidden
            } else {
                // Switch to wheel-only mode
                formSection.style.display = 'none';
                wheelSection.style.display = 'flex'; // Or 'block', depending on your CSS for .wheel-section
                adminSection.style.display = 'none'; // Ensure admin is hidden
                isWheelOnlyModeActive = true;
                if (wheelOnlyBtn) wheelOnlyBtn.classList.add('active');
                // Ensure wheel is sized and drawn correctly with enhanced mobile delay
                var mobileDelay = window.innerWidth <= 768 ? 100 : 50;
                setTimeout(function() {
                    if (typeof resizeWheel === 'function') resizeWheel();
                    if (typeof drawWheel === 'function') drawWheel();
                }, mobileDelay);
            }
        }

        // Initialize wheel with High-DPI support
        function initWheel() {
            canvasWheel = document.getElementById('wheel');
            if (!canvasWheel) {
                console.error("Wheel canvas element not found");
                return;
            }

            ctxWheel = canvasWheel.getContext('2d');
            if (!ctxWheel) {
                console.error("Could not get wheel canvas context");
                return;
            }

            // Setup high DPI canvas
            var dpr = window.devicePixelRatio || 1;
            var rect = canvasWheel.getBoundingClientRect();
            canvasWheel.width = rect.width * dpr;
            canvasWheel.height = rect.height * dpr;
            canvasWheel.style.width = rect.width + 'px';
            canvasWheel.style.height = rect.height + 'px';
            ctxWheel.scale(dpr, dpr);

            // Load the center logo
            rouletteCenterLogoImg = new Image();
            rouletteCenterLogoImg.onload = function() {
                drawWheel();
            };
            rouletteCenterLogoImg.onerror = function() {
                drawWheel();
            };

            try {
                var rouletteLogoDataUrl = localStorage.getItem('adminRouletteLogoDataUrl');
                if (rouletteLogoDataUrl) {
                    rouletteCenterLogoImg.src = rouletteLogoDataUrl;
                } else {
                    rouletteCenterLogoImg.src = 'QuartzLUBS-2.png';
                }
            } catch (e) {
                console.error("Error loading roulette logo from localStorage:", e);
                rouletteCenterLogoImg.src = 'QuartzLUBS-2.png';
            }

            // Initial sizing
            resizeWheel();

            // Enhanced resize handler with debouncing
            window.addEventListener('resize', debouncedResizeHandler, { passive: true });

            // Force initial draw even if logo hasn't loaded yet
            setTimeout(function() {
                drawWheel();
            }, 100);
        }

        // Enhanced resize function with size constraints
        function resizeWheel() {
            var container = document.querySelector('.wheel-container');
            if (!container || !canvasWheel) return;

            // Get container dimensions
            var containerWidth = container.clientWidth;
            var containerHeight = container.clientHeight;

            // Get container padding to ensure wheel fits within the border
            var containerStyle = window.getComputedStyle(container);
            var paddingLeft = parseFloat(containerStyle.paddingLeft);
            var paddingRight = parseFloat(containerStyle.paddingRight);
            var paddingTop = parseFloat(containerStyle.paddingTop);
            var paddingBottom = parseFloat(containerStyle.paddingBottom);

            // Calculate available space inside the padding
            var availableWidth = containerWidth - paddingLeft - paddingRight;
            var availableHeight = containerHeight - paddingTop - paddingBottom;

            var wheelSize = Math.min(availableWidth, availableHeight);

            // Apply size constraints based on screen size
            var screenWidth = window.innerWidth;
            if (screenWidth <= 320) {
                wheelSize = Math.max(240, Math.min(wheelSize, 280));
            } else if (screenWidth <= 480) {
                wheelSize = Math.max(280, Math.min(wheelSize, 350));
            } else if (screenWidth <= 768) {
                wheelSize = Math.max(350, Math.min(wheelSize, 500));
            } else if (screenWidth <= 1200) {
                wheelSize = Math.max(400, Math.min(wheelSize, 600));
            } else if (screenWidth <= 1600) {
                wheelSize = Math.max(500, Math.min(wheelSize, 700));
            } else {
                wheelSize = Math.max(600, Math.min(wheelSize, 800));
            }

            // Update global wheelSize variable
            window.wheelSize = wheelSize;

            // Update canvas dimensions
            canvasWheel.style.width = wheelSize + 'px';
            canvasWheel.style.height = wheelSize + 'px';

            // Account for high-DPI displays
            var dpr = window.devicePixelRatio || 1;
            canvasWheel.width = wheelSize * dpr;
            canvasWheel.height = wheelSize * dpr;

            // Reset the context and scale only once
            ctxWheel.setTransform(1, 0, 0, 1, 0, 0); // Reset any existing transforms
            ctxWheel.scale(dpr, dpr);

            // Set wheel center coordinates
            wheelCenterX = wheelSize / 2;
            wheelCenterY = wheelSize / 2;
        }

        // Create debounced resize handler
        var debouncedResizeHandler = debounce(function() {
            resizeWheel();
            drawWheel();
        }, 250);

        function drawWheel() {
            if (!ctxWheel) {
                console.error("Canvas context not available");
                return;
            }

            if (prizes.length === 0) {
                return;
            }

            // Ensure wheelSize is properly set
            if (!window.wheelSize) {
                resizeWheel();
            }

            var radius = window.wheelSize / 2;
            var sliceAngle = (2 * Math.PI) / prizes.length;

            // Update wheel center coordinates
            wheelCenterX = window.wheelSize / 2;
            wheelCenterY = window.wheelSize / 2;

            ctxWheel.clearRect(0, 0, window.wheelSize, window.wheelSize);

            // Adaptive font sizing based on wheel size and screen
            var screenWidth = window.innerWidth;
            var baseFontSize = radius * 0.06;

            // Adjust font size for different screen sizes
            if (screenWidth <= 320) {
                baseFontSize = Math.max(10, radius * 0.08);
            } else if (screenWidth <= 480) {
                baseFontSize = Math.max(12, radius * 0.07);
            } else if (screenWidth <= 768) {
                baseFontSize = Math.max(14, radius * 0.065);
            }

            // Apply text scale customization
            var textScale = getComputedStyle(document.documentElement).getPropertyValue('--wheel-text-scale') || 1;
            baseFontSize = baseFontSize * parseFloat(textScale);

            // Draw each slice of the wheel
            for (var i = 0; i < prizes.length; i++) {
                var startAngle = i * sliceAngle;
                var endAngle = (i + 1) * sliceAngle;

                ctxWheel.beginPath();
                ctxWheel.moveTo(wheelCenterX, wheelCenterY);
                ctxWheel.arc(wheelCenterX, wheelCenterY, radius, startAngle, endAngle);
                ctxWheel.closePath();

                // Use predefined wheel colors in sequence
                var colorIndex = i % wheelColors.length;
                ctxWheel.fillStyle = wheelColors[colorIndex];
                ctxWheel.fill();

                ctxWheel.lineWidth = 2;
                ctxWheel.strokeStyle = '#FFFFFF';
                ctxWheel.stroke();

                // Add prize text with adaptive sizing
                ctxWheel.save();
                ctxWheel.translate(wheelCenterX, wheelCenterY);
                ctxWheel.rotate(startAngle + sliceAngle / 2);

                ctxWheel.textAlign = 'right';
                ctxWheel.textBaseline = 'middle';
                ctxWheel.fillStyle = '#FFFFFF';
                ctxWheel.font = 'bold ' + baseFontSize + 'px Arial';
                ctxWheel.shadowColor = 'rgba(0,0,0,0.5)';
                ctxWheel.shadowBlur = 3;
                ctxWheel.shadowOffsetX = 1;
                ctxWheel.shadowOffsetY = 1;

                var textRadius = radius * 0.8;
                var maxTextWidth = radius * 0.5;

                // Adjust text width for smaller screens
                if (screenWidth <= 480) {
                    maxTextWidth = radius * 0.45;
                }

                // Enhanced text wrapping function
                function wrapText(context, text, x, y, maxWidth, lineHeight) {
                    var words = text.split(' ');
                    var line = '';
                    var testLine = '';
                    var metrics;
                    var testWidth;

                    for (var n = 0; n < words.length; n++) {
                        testLine = line + words[n] + ' ';
                        metrics = context.measureText(testLine);
                        testWidth = metrics.width;
                        if (testWidth > maxWidth && n > 0) {
                            context.fillText(line.trim(), x, y);
                            line = words[n] + ' ';
                            y += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    if (line.trim()) {
                        context.fillText(line.trim(), x, y);
                    }
                }

                // Adaptive line height
                var lineHeight = Math.max(baseFontSize * 1.2, radius * 0.07);
                wrapText(ctxWheel, prizes[i].text, textRadius, 0, maxTextWidth, lineHeight);

                ctxWheel.restore();
            }

            // Draw center circle
            ctxWheel.beginPath();
            ctxWheel.arc(wheelCenterX, wheelCenterY, radius * 0.2, 0, 2 * Math.PI);
            ctxWheel.fillStyle = '#FFFFFF';
            ctxWheel.fill();
            ctxWheel.strokeStyle = '#FFFFFF00';
            ctxWheel.lineWidth = 3;
            ctxWheel.stroke();

            // Draw center logo with adaptive sizing
            if (rouletteCenterLogoImg && rouletteCenterLogoImg.complete) {
                var logoSize = radius * 0.18;

                // Adjust logo size for very small screens
                if (screenWidth <= 320) {
                    logoSize = radius * 0.15;
                } else if (screenWidth <= 480) {
                    logoSize = radius * 0.16;
                }

                ctxWheel.save();
                ctxWheel.beginPath();
                ctxWheel.arc(wheelCenterX, wheelCenterY, logoSize, 0, Math.PI * 2, true);
                ctxWheel.closePath();
                ctxWheel.clip();

                ctxWheel.drawImage(
                    rouletteCenterLogoImg,
                    wheelCenterX - logoSize,
                    wheelCenterY - logoSize,
                    logoSize * 2,
                    logoSize * 2
                );
                ctxWheel.restore();
            }

            // Draw wheel pointer
            ctxWheel.beginPath();
            ctxWheel.moveTo(wheelCenterX, wheelCenterY - radius - 10);
            ctxWheel.lineTo(wheelCenterX - 15, wheelCenterY - radius + 20);
            ctxWheel.lineTo(wheelCenterX + 15, wheelCenterY - radius + 20);
            ctxWheel.closePath();
            ctxWheel.fillStyle = window.customPointerColor || '#ff0000';
            ctxWheel.fill();
            ctxWheel.strokeStyle = '#FFFFFF';
            ctxWheel.lineWidth = 2;
            ctxWheel.stroke();
        }

        // Admin Panel Toggle with password
        adminToggleBtn.addEventListener('click', function() {
            if (adminSection.style.display === 'none' || adminSection.style.display === '') {
                // Store current states before showing admin panel
                formSectionDisplayBeforeAdmin = formSection.style.display;
                wheelSectionDisplayBeforeAdmin = wheelSection.style.display;

                // Show password modal
                passwordAdminModal.style.display = 'flex';
                adminPasswordInput.value = '';
                adminPasswordInput.focus();
            } else {
                // Hide admin panel and restore previous view
                adminSection.style.display = 'none';
                if(adminToggleBtn) adminToggleBtn.classList.remove('active');

                // Restore the previous state based on stored values
                formSection.style.display = formSectionDisplayBeforeAdmin;
                wheelSection.style.display = wheelSectionDisplayBeforeAdmin;

                // If wheel was supposed to be visible, redraw it with enhanced mobile delay
                if (wheelSectionDisplayBeforeAdmin === 'flex' || wheelSectionDisplayBeforeAdmin === 'block') {
                    var mobileDelay = window.innerWidth <= 768 ? 100 : 50;
                    setTimeout(function() {
                        if (typeof resizeWheel === 'function') resizeWheel();
                        if (typeof drawWheel === 'function') drawWheel();
                    }, mobileDelay);
                }
                resetIdleTimer();
            }
        });

        submitAdminPasswordBtn.addEventListener('click', function() {
            var password = adminPasswordInput.value;
            if (password === "WW@TE2025") {
                passwordAdminModal.style.display = 'none';

                // Show admin panel and hide others
                adminSection.style.display = 'block';
                formSection.style.display = 'none';
                wheelSection.style.display = 'none';

                // Update admin button visual state
                adminToggleBtn.classList.add('active');

                showToast("Panel de administración desbloqueado", "success");
            } else {
                showToast("Contraseña incorrecta.", "error");
                adminPasswordInput.value = '';
                adminPasswordInput.focus();
            }
        });

        adminPasswordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitAdminPasswordBtn.click();
            }
        });

        cancelAdminPasswordBtn.addEventListener('click', function() {
            passwordAdminModal.style.display = 'none';
            // Restore the view that was active before trying to open admin
            formSection.style.display = formSectionDisplayBeforeAdmin;
            wheelSection.style.display = wheelSectionDisplayBeforeAdmin;
            if (wheelSectionDisplayBeforeAdmin === 'flex' || wheelSectionDisplayBeforeAdmin === 'block') {
                var mobileDelay = window.innerWidth <= 768 ? 100 : 50;
                setTimeout(function() {
                    if (typeof resizeWheel === 'function') resizeWheel();
                    if (typeof drawWheel === 'function') drawWheel();
                }, mobileDelay);
            }
            resetIdleTimer();
        });

        window.addEventListener('click', function(event) {
            if (event.target == passwordAdminModal) {
                passwordAdminModal.style.display = 'none';
                // Restore the view
                formSection.style.display = formSectionDisplayBeforeAdmin;
                wheelSection.style.display = wheelSectionDisplayBeforeAdmin;
                if (wheelSectionDisplayBeforeAdmin === 'flex' || wheelSectionDisplayBeforeAdmin === 'block') {
                    var mobileDelay = window.innerWidth <= 768 ? 100 : 50;
                    setTimeout(function() {
                        if (typeof resizeWheel === 'function') resizeWheel();
                        if (typeof drawWheel === 'function') drawWheel();
                    }, mobileDelay);
                }
                resetIdleTimer();
            }
            if (event.target == prizeModal) {
                prizeModal.style.display = 'none';
            }
        });

        // Save Admin Settings
        saveAdminSettingsBtn.addEventListener('click', function() {
            try {
                showToast('Configuración guardada!');
            } catch (e) {
                console.error("Error saving admin settings:", e);
                showToast('Error al guardar configuración.', 'error');
            }
        });

        // Handle Company Logo Upload
        function handleCompanyLogoUpload(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        localStorage.setItem('adminCompanyLogoDataUrl', e.target.result);
                        companyLogoElement.src = e.target.result;
                        companyLogoElement.style.display = 'inline-block';
                        showToast('Logo de empresa actualizado.');
                    } catch (err) {
                        console.error("Error saving company logo:", err);
                        showToast('Error al guardar logo de empresa.', 'error');
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // Handle Roulette Logo Upload
        function handleRouletteLogoUpload(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        localStorage.setItem('adminRouletteLogoDataUrl', e.target.result);
                        rouletteCenterLogoImg = new Image();
                        rouletteCenterLogoImg.onload = function() {
                            drawWheel();
                            showToast('Logo de ruleta actualizado.');
                        };
                        rouletteCenterLogoImg.onerror = function() {
                            rouletteCenterLogoImg = null;
                            drawWheel();
                            showToast('Error al cargar imagen de logo para ruleta.', 'error');
                        };
                        rouletteCenterLogoImg.src = e.target.result;
                    } catch (err) {
                        console.error("Error saving roulette logo:", err);
                        showToast('Error al guardar logo de ruleta.', 'error');
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // Wheel Customization Functions
        function setupWheelCustomizationListeners() {
            var wheelSizeSlider = document.getElementById('adminWheelSize');
            var borderWidthSlider = document.getElementById('adminWheelBorderWidth');
            var borderColorInput = document.getElementById('adminWheelBorderColor');
            var bgOpacitySlider = document.getElementById('adminWheelBgOpacity');
            var pointerColorInput = document.getElementById('adminPointerColor');
            var textSizeSlider = document.getElementById('adminTextSize');
            var applyBtn = document.getElementById('applyWheelCustomization');
            var resetBtn = document.getElementById('resetWheelDefaults');

            // Update display values for sliders
            if (wheelSizeSlider) {
                wheelSizeSlider.addEventListener('input', function(e) {
                    document.getElementById('wheelSizeValue').textContent = e.target.value + '%';
                });
            }

            if (borderWidthSlider) {
                borderWidthSlider.addEventListener('input', function(e) {
                    document.getElementById('borderWidthValue').textContent = e.target.value + 'px';
                });
            }

            if (bgOpacitySlider) {
                bgOpacitySlider.addEventListener('input', function(e) {
                    document.getElementById('bgOpacityValue').textContent = e.target.value + '%';
                });
            }

            if (textSizeSlider) {
                textSizeSlider.addEventListener('input', function(e) {
                    document.getElementById('textSizeValue').textContent = e.target.value + '%';
                });
            }

            // Apply customization
            if (applyBtn) {
                applyBtn.addEventListener('click', applyWheelCustomization);
            }

            // Reset to defaults
            if (resetBtn) {
                resetBtn.addEventListener('click', resetWheelDefaults);
            }

            // Load saved customization settings
            loadWheelCustomizationSettings();
        }

        function applyWheelCustomization() {
            var wheelSize = document.getElementById('adminWheelSize').value;
            var borderWidth = document.getElementById('adminWheelBorderWidth').value;
            var borderColor = document.getElementById('adminWheelBorderColor').value;
            var bgOpacity = document.getElementById('adminWheelBgOpacity').value;
            var pointerColor = document.getElementById('adminPointerColor').value;
            var textSize = document.getElementById('adminTextSize').value;

            // Save settings to localStorage
            localStorage.setItem('wheelCustomization', JSON.stringify({
                wheelSize: wheelSize,
                borderWidth: borderWidth,
                borderColor: borderColor,
                bgOpacity: bgOpacity,
                pointerColor: pointerColor,
                textSize: textSize
            }));

            // Apply to CSS
            var wheelContainer = document.querySelector('.wheel-container');
            if (wheelContainer) {
                wheelContainer.style.maxWidth = (6 * (wheelSize / 100)) + 'px';
                wheelContainer.style.maxHeight = (6 * (wheelSize / 100)) + 'px';
                wheelContainer.style.padding = borderWidth + 'px';
                wheelContainer.style.background = 'rgba(255, 255, 255, ' + (bgOpacity / 100) + ')';
                if (borderWidth > 0) {
                    wheelContainer.style.border = Math.max(1, borderWidth / 2) + 'px solid ' + borderColor;
                }
            }

            // Update text size through CSS variable
            document.documentElement.style.setProperty('--wheel-text-scale', textSize / 100);

            // Store pointer color for drawWheel function
            window.customPointerColor = pointerColor;

            // Redraw wheel with new settings
            if (typeof resizeWheel === 'function') resizeWheel();
            if (typeof drawWheel === 'function') drawWheel();

            showToast('Personalización aplicada!', 'success');
        }

        function resetWheelDefaults() {
            document.getElementById('adminWheelSize').value = 100;
            document.getElementById('adminWheelBorderWidth').value = 10;
            document.getElementById('adminWheelBorderColor').value = '#ffffff';
            document.getElementById('adminWheelBgOpacity').value = 70;
            document.getElementById('adminPointerColor').value = '#ff0000';
            document.getElementById('adminTextSize').value = 100;

            // Update display values
            document.getElementById('wheelSizeValue').textContent = '100%';
            document.getElementById('borderWidthValue').textContent = '10px';
            document.getElementById('bgOpacityValue').textContent = '70%';
            document.getElementById('textSizeValue').textContent = '100%';

            // Remove from localStorage
            localStorage.removeItem('wheelCustomization');

            // Reset CSS
            var wheelContainer = document.querySelector('.wheel-container');
            if (wheelContainer) {
                wheelContainer.style.maxWidth = '600px';
                wheelContainer.style.maxHeight = '600px';
                wheelContainer.style.padding = '10px';
                wheelContainer.style.background = 'rgba(255, 255, 255, 0.7)';
                wheelContainer.style.border = '';
            }

            document.documentElement.style.setProperty('--wheel-text-scale', 1);
            window.customPointerColor = '#ff0000';

            if (typeof resizeWheel === 'function') resizeWheel();
            if (typeof drawWheel === 'function') drawWheel();

            showToast('Valores restablecidos a los predeterminados!', 'success');
        }

        function loadWheelCustomizationSettings() {
            try {
                var saved = localStorage.getItem('wheelCustomization');
                if (saved) {
                    var settings = JSON.parse(saved);

                    document.getElementById('adminWheelSize').value = settings.wheelSize || 100;
                    document.getElementById('adminWheelBorderWidth').value = settings.borderWidth || 10;
                    document.getElementById('adminWheelBorderColor').value = settings.borderColor || '#ffffff';
                    document.getElementById('adminWheelBgOpacity').value = settings.bgOpacity || 70;
                    document.getElementById('adminPointerColor').value = settings.pointerColor || '#ff0000';
                    document.getElementById('adminTextSize').value = settings.textSize || 100;

                    // Update display values
                    document.getElementById('wheelSizeValue').textContent = (settings.wheelSize || 100) + '%';
                    document.getElementById('borderWidthValue').textContent = (settings.borderWidth || 10) + 'px';
                    document.getElementById('bgOpacityValue').textContent = (settings.bgOpacity || 70) + '%';
                    document.getElementById('textSizeValue').textContent = (settings.textSize || 100) + '%';

                    // Apply the settings without showing toast
                    setTimeout(function() {
                        var wheelContainer = document.querySelector('.wheel-container');
                        if (wheelContainer) {
                            wheelContainer.style.maxWidth = (6 * ((settings.wheelSize || 100) / 100)) + 'px';
                            wheelContainer.style.maxHeight = (6 * ((settings.wheelSize || 100) / 100)) + 'px';
                            wheelContainer.style.padding = (settings.borderWidth || 10) + 'px';
                            wheelContainer.style.background = 'rgba(255, 255, 255, ' + ((settings.bgOpacity || 70) / 100) + ')';
                            if ((settings.borderWidth || 10) > 0) {
                                wheelContainer.style.border = Math.max(1, (settings.borderWidth || 10) / 2) + 'px solid ' + (settings.borderColor || '#ffffff');
                            }
                        }

                        document.documentElement.style.setProperty('--wheel-text-scale', (settings.textSize || 100) / 100);
                        window.customPointerColor = settings.pointerColor || '#ff0000';

                        if (typeof resizeWheel === 'function') resizeWheel();
                        if (typeof drawWheel === 'function') drawWheel();
                    }, 100);
                }
            } catch (e) {
                console.error('Error loading wheel customization settings:', e);
            }
        }

        // Prize Management
        prizeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var text = prizeTextAdminInput.value.trim();
            var color = prizeColorAdminInput.value;
            var probability = parseInt(prizeProbabilityAdminInput.value);
            var quantity = parseInt(prizeQuantityAdminInput.value);
            var editIndex = prizeEditIndexInput.value;

            if (!text || probability <= 0) {
                showToast("Por favor, completa el nombre del premio y asegúrate que la probabilidad sea mayor a 0.", "warning");
                return;
            }

            var newPrize = { text: text, color: color, probability: probability, quantity: quantity, initialQuantity: quantity };

            if (editIndex === "") {
                prizes.push(newPrize);
            } else {
                prizes[parseInt(editIndex)] = newPrize;
            }

            savePrizes();
            renderPrizesTable();
            drawWheel();
            prizeForm.reset();
            prizeColorAdminInput.value = "#ff0000";
            prizeQuantityAdminInput.value = "10";
            prizeProbabilityAdminInput.value = "10";
            prizeEditIndexInput.value = "";
            showToast("Premio guardado correctamente.");
        });

        function renderPrizesTable() {
            prizesTableBody.innerHTML = "";
            prizes.forEach(function(prize, index) {
                var row = prizesTableBody.insertRow();
                row.insertCell().textContent = prize.text;

                var colorCell = row.insertCell();
                colorCell.style.backgroundColor = prize.color;
                var textColor = getContrastYIQ(prize.color);
                colorCell.style.color = textColor;
                colorCell.textContent = prize.color;

                row.insertCell().textContent = prize.probability;
                row.insertCell().textContent = prize.quantity === 0 ? "Ilimitado" : prize.quantity + '/' + prize.initialQuantity;

                var actionsCell = row.insertCell();
                var editBtn = document.createElement('button');
                editBtn.textContent = 'Editar';
                editBtn.classList.add('btn', 'action-btn');
                editBtn.onclick = function() { editPrize(index); };
                actionsCell.appendChild(editBtn);

                var deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Eliminar';
                deleteBtn.classList.add('btn', 'action-btn');
                deleteBtn.style.backgroundColor = '#f44336';
                deleteBtn.onclick = function() { deletePrize(index); };
                actionsCell.appendChild(deleteBtn);
            });
        }

        function getContrastYIQ(hexcolor){
            hexcolor = hexcolor.replace("#", "");
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        function editPrize(index) {
            var prize = prizes[index];
            prizeTextAdminInput.value = prize.text;
            prizeColorAdminInput.value = prize.color;
            prizeProbabilityAdminInput.value = prize.probability;
            prizeQuantityAdminInput.value = prize.quantity;
            prizeEditIndexInput.value = index;
            prizeTextAdminInput.focus();
        }

        function deletePrize(index) {
            if (confirm('¿Seguro que quieres eliminar el premio "' + prizes[index].text + '"?')) {
                prizes.splice(index, 1);
                savePrizes();
                renderPrizesTable();
                drawWheel();
                showToast("Premio eliminado correctamente.");
            }
        }

        function savePrizes() {
            try {
                localStorage.setItem('roulettePrizes', JSON.stringify(prizes));
            } catch (e) {
                console.error("Error saving prizes:", e);
                showToast('Error al guardar premios.', 'error');
            }
        }

        function loadPrizes() {
            try {
                var storedPrizes = localStorage.getItem('roulettePrizes');
                if (storedPrizes) {
                    prizes = JSON.parse(storedPrizes);
                    prizes.forEach(function(p) {
                        if (p.initialQuantity === undefined) {
                            p.initialQuantity = p.quantity;
                        }
                    });
                } else {
                    prizes = JSON.parse(JSON.stringify(defaultPrizes));
                }

                if (!prizes || prizes.length === 0) {
                    prizes = JSON.parse(JSON.stringify(defaultPrizes));
                    savePrizes();
                }
            } catch (e) {
                console.error("Error loading prizes:", e);
                prizes = JSON.parse(JSON.stringify(defaultPrizes));
                savePrizes();
            }
        }

        function renderParticipantsTable() {
            participantsTableBody.innerHTML = "";
            participants.forEach(function(p) {
                var row = participantsTableBody.insertRow();
                row.insertCell().textContent = p.name;
                row.insertCell().textContent = p.email;
                row.insertCell().textContent = p.phone;
                row.insertCell().textContent = p.subscribe ? 'Sí' : 'No';
                row.insertCell().textContent = new Date(p.date).toLocaleString();
                row.insertCell().textContent = p.prize || "N/A";
            });
        }

        function saveParticipants() {
            try {
                localStorage.setItem('rouletteParticipants', JSON.stringify(participants));
            } catch (e) {
                console.error("Error saving participants:", e);
                showToast('Error al guardar datos de participante.', 'error');
            }
        }

        function loadParticipants() {
            try {
                var storedParticipants = localStorage.getItem('rouletteParticipants');
                if (storedParticipants) {
                    participants = JSON.parse(storedParticipants);
                }
            } catch (e) {
                console.error("Error loading participants:", e);
                participants = [];
            }
        }

        clearParticipantsBtn.addEventListener('click', function() {
            if (confirm("¿Seguro que quieres eliminar todos los datos de los participantes? Esta acción no se puede deshacer.")) {
                participants = [];
                saveParticipants();
                renderParticipantsTable();
                showToast("Datos de participantes eliminados.");
            }
        });

        exportCsvBtn.addEventListener('click', function() {
            if (participants.length === 0) {
                showToast("No hay participantes para exportar", "warning");
                return;
            }
            var csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nombre,Correo Electrónico,Teléfono,Desea Recibir Información,Fecha,Premio Ganado\r\n";
            participants.forEach(function(p) {
                var dateFormatted = new Date(p.date).toLocaleString();
                var prizeWon = p.prize || "N/A";
                var subscribed = p.subscribe ? 'Sí' : 'No';
                var row = '"' + p.name + '","' + p.email + '","' + p.phone + '","' + subscribed + '","' + dateFormatted + '","' + prizeWon + '"';
                csvContent += row + "\r\n";
            });
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "participantes_ruleta.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        participantForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var name = document.getElementById('name').value;
            var email = document.getElementById('email').value;
            var phone = document.getElementById('phone').value;
            var subscribe = document.getElementById('subscribe').checked;

            if (!name || !email || !phone) {
                showToast("Por favor, complete todos los campos del formulario.", "warning");
                return;
            }

            var participant = {
                id: Date.now(),
                name: name,
                email: email,
                phone: phone,
                subscribe: subscribe,
                date: new Date().toISOString(),
                prize: null
            };

            participants.push(participant);
            saveParticipants();
            renderParticipantsTable();

            participantForm.reset();

            showToast("Cargando ruleta...", "info");

            formSection.style.display = 'none';
            adminSection.style.display = 'none';
            wheelSection.style.display = 'flex';

            isWheelOnlyModeActive = false;
            if(wheelOnlyBtn) wheelOnlyBtn.classList.remove('active');

            var mobileDelay = window.innerWidth <= 768 ? 100 : 50;
            setTimeout(function() {
                if (typeof resizeWheel === 'function') resizeWheel();
                if (typeof drawWheel === 'function') drawWheel();
            }, mobileDelay);

            showToast("¡Datos registrados correctamente! Ahora puedes girar la ruleta.", "success");

            resetIdleTimer();
        });

        function spinWheel() {
            if (isSpinning) return;

            var availablePrizes = prizes.filter(function(p) {
                return p.initialQuantity === 0 || p.quantity > 0;
            });
            if (availablePrizes.length === 0) {
                showToast("¡Todos los premios se han agotado!", "warning");
                resultDiv.textContent = "No quedan premios.";
                return;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            resultDiv.textContent = "Girando...";

            var totalProbability = availablePrizes.reduce(function(sum, prize) {
                return sum + prize.probability;
            }, 0);
            var randomValue = Math.random() * totalProbability;

            var cumulativeProbability = 0;
            selectedPrizeIndex = -1;
            var actualPrizeArrayIndex = -1;

            for (var i = 0; i < availablePrizes.length; i++) {
                cumulativeProbability += availablePrizes[i].probability;
                if (randomValue <= cumulativeProbability) {
                    selectedPrizeIndex = prizes.indexOf(availablePrizes[i]);
                    actualPrizeArrayIndex = i;
                    break;
                }
            }

            if (selectedPrizeIndex === -1) {
                selectedPrizeIndex = prizes.indexOf(availablePrizes[availablePrizes.length - 1]);
                actualPrizeArrayIndex = availablePrizes.length - 1;
            }

            var prize = prizes[selectedPrizeIndex];

            var numSegments = availablePrizes.length;
            var segmentAngleDegrees = 360 / numSegments;

            var targetAngleForSelectedSegment = (actualPrizeArrayIndex + 0.5) * segmentAngleDegrees;

            var finalAngleMod360 = (270 - targetAngleForSelectedSegment + 360) % 360;

            var randomSpins = 5 + Math.floor(Math.random() * 5);
            var totalExtraRotation = randomSpins * 360;

            var newTargetRotationDegrees = currentRotationDegrees - (currentRotationDegrees % 360) + totalExtraRotation + finalAngleMod360;

            if (newTargetRotationDegrees <= currentRotationDegrees + segmentAngleDegrees) {
                 newTargetRotationDegrees += 360 * (1 + Math.floor(Math.random()*2));
            }

            targetRotationDegrees = newTargetRotationDegrees;
            var spinDuration = 5;

            if (canvasWheel) {
                canvasWheel.style.transition = 'transform ' + (spinDuration + 2) + 's cubic-bezier(0.25, 0.1, 0.25, 1)';
                void canvasWheel.offsetHeight;

                requestAnimationFrame(function() {
                    canvasWheel.style.transform = 'rotate(' + targetRotationDegrees + 'deg)';
                });

                var onSpinEndHandler = function() {
                    isSpinning = false;
                    spinBtn.disabled = false;
                    currentRotationDegrees = targetRotationDegrees;

                    resultDiv.textContent = '¡Has ganado: ' + prize.text + '!';

                    prizeModalText.textContent = '¡Has ganado: ' + prize.text + '!';
                    prizeModal.style.display = 'flex';
                    createConfetti();
                    triggerFireworks();

                    if (prize.initialQuantity !== 0 && prize.quantity > 0) {
                        prize.quantity--;
                        savePrizes();
                        renderPrizesTable();
                    }

                    if (participants.length > 0) {
                        var lastParticipant = participants[participants.length - 1];
                        lastParticipant.prize = prize.text;
                        saveParticipants();
                        renderParticipantsTable();
                    }

                    canvasWheel.removeEventListener('transitionend', onSpinEndHandler);
                    canvasWheel.style.transition = 'none';
                };

                canvasWheel.addEventListener('transitionend', onSpinEndHandler);
            } else {
                console.error("Wheel canvas element not found for spinning.");
                isSpinning = false;
                spinBtn.disabled = false;
                resultDiv.textContent = "Error al girar.";
                showToast("Error al girar la ruleta", "error");
            }
        }

        function wrapTextForWheel(context, text, maxWidth) {
            var words = text.split(' ');
            if (words.length === 0) return [];
            var lines = [];
            var currentLine = words[0] || "";

            for (var i = 1; i < words.length; i++) {
                var word = words[i];
                var testLine = currentLine + " " + word;
                if (context.measureText(testLine).width < maxWidth) {
                    currentLine = testLine;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            if (currentLine) {
                lines.push(currentLine);
            }
            return lines;
        }

        function createConfetti() {
            var confettiCount = 200;
            var confettiContainer = document.body;
            for (var i = 0; i < confettiCount; i++) {
                var confettiPiece = document.createElement('div');
                confettiPiece.classList.add('confetti');
                confettiPiece.style.left = Math.random() * 100 + 'vw';
                confettiPiece.style.top = Math.random() * -50 + 'vh';

                var colorIndex = Math.floor(Math.random() * wheelColors.length);
                confettiPiece.style.backgroundColor = wheelColors[colorIndex];

                confettiPiece.style.animationDuration = (Math.random() * 4 + 8) + 's';
                confettiPiece.style.animationDelay = Math.random() * 1 + 's';
                confettiPiece.style.transform = 'rotate(' + (Math.random() * 360) + 'deg) scale(' + (Math.random() * 0.5 + 0.5) + ')';
                confettiContainer.appendChild(confettiPiece);

                setTimeout(function() {
                    confettiPiece.remove();
                }, 12000);
            }
        }

        function triggerFireworks() {
            var fireworkCount = 30;

            for (var i = 0; i < fireworkCount; i++) {
                var numParticles = 30 + Math.floor(Math.random() * 20);

                var burstX = Math.random() * window.innerWidth;
                var burstY = Math.random() * window.innerHeight;

                for (var j = 0; j < numParticles; j++) {
                    var particle = document.createElement('div');
                    particle.classList.add('firework-particle');

                    var angle = Math.random() * Math.PI * 2;
                    var distance = Math.random() * 100 + 50;
                    var translateX = Math.cos(angle) * distance;
                    var translateY = Math.sin(angle) * distance - (Math.random() * 30 + 20);

                    particle.style.setProperty('--translateX', translateX + 'px');
                    particle.style.setProperty('--translateY', translateY + 'px');
                    particle.style.left = burstX + 'px';
                    particle.style.top = burstY + 'px';

                    var colorIndex = Math.floor(Math.random() * wheelColors.length);
                    particle.style.backgroundColor = wheelColors[colorIndex];

                    document.body.appendChild(particle);

                    setTimeout(function() {
                        particle.remove();
                    }, 4000);
                }
            }
        }

        function resetForm() {
            if(participantForm) {
                participantForm.reset();
            }

            formSection.style.display = 'block';
            wheelSection.style.display = 'none';
            adminSection.style.display = 'none';
            if(resultDiv) resultDiv.textContent = '';

            if (canvasWheel) {
                canvasWheel.style.transition = 'none';
                currentRotationDegrees = currentRotationDegrees % 360;
                canvasWheel.style.transform = 'rotate(' + currentRotationDegrees + 'deg)';
            }

            isSpinning = false;
            if (spinBtn) {
                spinBtn.disabled = false;
            }
            isWheelOnlyModeActive = false;
            if(wheelOnlyBtn) wheelOnlyBtn.classList.remove('active');
            resetIdleTimer();
        }
    })();
    </script>
