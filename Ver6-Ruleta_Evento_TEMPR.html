<!-- Developed by Wilhem Jeldes, MS for Wanda Winter of TotalEnergies. May, 2025. -->
<!-- Ver6: Enhanced Scaling and Mobile Responsive Design -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario y Ruleta para Evento - Ver6 Enhanced</title>
    <style>
        :root {
            --header-bg-color: #ff0000; /* Header banner color */
            --header-text-color: white;
            --button-bg-color: #285aff; /* Form button color */
            --button-text-color: white;
            --spin-button-bg-color: #28c896; /* Wheel button color */
            --wheel-indicator-color: #ff0000;
            --modal-title-color: #ff0000;
            --prize-out-of-stock-color: #7f8c8d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 100%;
        }
        
        .header {
            background-color: var(--header-bg-color);
            color: var(--header-text-color);
            text-align: center;
            padding: 15px 20px;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            max-height: 80px;
            max-width: 300px;
            object-fit: contain;
            margin-right: 15px;
        }
        
        .header-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .robot-quartz-gif {
            height: 60px;
            margin-left: 15px;
        }        .header-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }        .admin-toggle-btn {
            background-color: var(--button-bg-color);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .admin-toggle-btn.active {
            background-color: var(--header-bg-color);
            transform: scale(1.05);
        }.wheel-only-button {
            background-color: white;
            border: 2px solid var(--spin-button-bg-color);
            width: 45px;
            height: 45px;
            border-radius: 50%; /* Make it circular */
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            padding: 0;
        }
        
        .wheel-icon {
            width: 35px;
            height: 35px;
            object-fit: contain;
            transition: transform 0.3s;
        }
        
        .wheel-only-button.form-mode .wheel-icon {
            transform: rotate(180deg);
        }
        
        .wheel-only-button:hover {
            transform: rotate(20deg);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }
        
        .admin-toggle-btn:hover {
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }        .form-section {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            position: relative;
        }
        
        .form-section::before, .form-section::after {
            content: '';
            position: absolute;
            width: 150px;
            height: 300px;
            background-image: url('TA6-totalenergies-quartz-extra-1.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1;
            top: 50%;
            transform: translateY(-50%);
        }

        .form-section::before {
            left: -160px;
        }

        .form-section::after {
            right: -160px;
        }.form-inner {
            background: rgba(255, 255, 255, 0.92);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            position: relative;
            z-index: 1;
        }
        
        .admin-section {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            display: none; /* Hidden by default */
        }

        .admin-section h3 {
            color: var(--header-bg-color);
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--header-bg-color);
            padding-bottom: 5px;
        }
        
        .form-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--header-bg-color);
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 18px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--button-bg-color);
            outline: none;
        }

        input[type="color"] {
            padding: 5px;
            height: 40px;
        }
        
        .btn {
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
          .wheel-section {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background-color: white;
        }

        .wheel-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            max-height: 600px;
            aspect-ratio: 1/1;
            margin: 30px auto;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            padding: 10px;
        }
        
        #wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            transition: transform 7s cubic-bezier(0.25, 0.1, 0.25, 1);
            transform: rotate(0deg);
            box-shadow: 0 0 20px rgba(0,0,0,0.3), inset 0 0 10px rgba(0,0,0,0.2);
        }
        
        .wheel-indicator {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid var(--wheel-indicator-color);
            z-index: 10;
        }
                
        .spin-button {
            background-color: var(--spin-button-bg-color);
            margin-top: 30px;
            width: 200px;
        }
        
        .logo-below-wheel {
            margin-top: 30px;
            margin-bottom: 20px;
            width: 200px;
        }
        
        #result {
            text-align: center;
            margin-top: 30px;
            font-size: 30px;
            font-weight: bold;
            color: var(--modal-title-color);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 80%;
            width: 500px;
            position: relative;
            animation: popup 0.5s;
        }
        
        @keyframes popup {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .firework-particle {
            position: fixed;
            width: 5px;
            height: 5px;
            /* background-color will be set by JS */
            border-radius: 50%;
            z-index: 1001;
            pointer-events: none;
            animation: explodeAndFall 2s ease-out forwards;
            animation-iteration-count: 2;
        }

        @keyframes explodeAndFall {
            0% {
                transform: translate(0, 0) scale(0.3);
                opacity: 1;
            }
            30% {
                transform: translate(var(--translateX), var(--translateY)) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--translateX), calc(var(--translateY) + 70px)) scale(0);
                opacity: 0;
            }
        }
        
        .prize-title {
            color: var(--modal-title-color);
            font-size: 32px;
            margin-bottom: 20px;
        }
        
        .prize-text {
            font-size: 24px;
            margin-bottom: 30px;
        }
        
        .close-modal {
            margin-top: 20px;
            background-color: var(--spin-button-bg-color);
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            /* background-color will be set by JS */
            animation-name: confetti-fall;
            animation-timing-function: ease-in-out;
            animation-fill-mode: forwards;
            z-index: 999;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); }
            100% { transform: translateY(100vh) rotate(720deg); }
        }

        /* Admin Panel Table Styles */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .admin-table th, .admin-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }
        .admin-table th {
            background-color: #f2f2f2;
            color: #333;
        }
        .admin-table .action-btn {
            padding: 5px 8px;
            font-size: 12px;
            margin-right: 5px;
        }
          /* Enhanced responsive design media queries */
        @media (max-width: 320px) {
            .wheel-container {
                width: 95vw;
                height: 95vw;
                max-width: 280px;
                max-height: 280px;
                min-width: 240px;
                min-height: 240px;
            }
            
            #spinBtn {
                font-size: 12px;
                padding: 6px 12px;
                min-height: 44px;
                min-width: 88px;
            }
            
            .header {
                font-size: 18px;
                padding: 10px 15px;
            }
            
            .header-logo {
                max-height: 35px;
            }
            
            .form-section, .admin-section {
                padding: 15px;
                margin: 10px;
            }
        }

        @media (min-width: 321px) and (max-width: 480px) {
            .wheel-container {
                width: 90vw;
                height: 90vw;
                max-width: 350px;
                max-height: 350px;
                min-width: 280px;
                min-height: 280px;
            }
            
            #spinBtn {
                font-size: 14px;
                padding: 8px 16px;
                min-height: 44px;
                min-width: 100px;
            }
            
            .header {
                font-size: 20px;
            }
            
            .header-logo {
                max-height: 40px;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .wheel-container {
                width: 85vw;
                height: 85vw;
                max-width: 500px;
                max-height: 500px;
                min-width: 350px;
                min-height: 350px;
            }
            
            #spinBtn {
                font-size: 16px;
                padding: 10px 20px;
                min-height: 48px;
                min-width: 120px;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .wheel-container {
                width: 70vw;
                height: 70vw;
                max-width: 600px;
                max-height: 600px;
                min-width: 400px;
                min-height: 400px;
            }
            
            #spinBtn {
                font-size: 18px;
                padding: 12px 24px;
                min-height: 50px;
                min-width: 140px;
            }
        }

        @media (min-width: 1201px) and (max-width: 1600px) {
            .wheel-container {
                width: 60vw;
                height: 60vw;
                max-width: 700px;
                max-height: 700px;
                min-width: 500px;
                min-height: 500px;
            }
        }

        @media (min-width: 1601px) {
            .wheel-container {
                width: 50vw;
                height: 50vw;
                max-width: 800px;
                max-height: 800px;
                min-width: 600px;
                min-height: 600px;
            }
        }

        /* Touch optimization */
        .btn, .admin-toggle-btn, .wheel-only-button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Enhanced touch targets for mobile */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .admin-toggle-btn, .wheel-only-button {
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Para pantallas verticales */
        @media (orientation: portrait) {
            .container {
                max-width: 100%;
                width: 100%;
            }
            .header {
                font-size: 22px;
            }
            .header-logo {
                max-height: 40px;
            }
            .admin-toggle-btn {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        /* Password Modal Styles */
        .password-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }

        .password-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .password-modal-content h3 {
            color: var(--header-bg-color);
            margin-bottom: 20px;
        }

        .password-modal-content input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .password-modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .password-modal-submit {
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
        }

        .password-modal-cancel {
            background-color: #ccc;
            color: #333;
        }

        /* Toast Notification Styles */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease;
            font-size: 16px;
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background-color: #e74c3c;
        }

        .toast.warning {
            background-color: #f39c12;
        }

        .toast.success {
            background-color: #2ecc71;
        }
    </style>
</head>
<body>
    <div id="toastContainer"></div>
    <div class="container">        <div class="header">
            <img src="Quartz Banner.png" alt="Quartz Banner" id="companyLogo" class="header-logo">
            <div class="header-center">
                <span id="headerTitle">TotalEnergies Quartz - Ruleta de Premios</span>
                <img src="Robotquartz-TotalEnergies.gif" alt="RobotQuartz GIF" class="robot-quartz-gif">
            </div>            <div class="header-buttons">
                <button id="adminToggleBtn" class="admin-toggle-btn">AP</button>
                <button id="wheelOnlyBtn" class="admin-toggle-btn" title="Solo mostrar la ruleta">Wh</button>
            </div>
        </div>
        
        <div class="content">
            <div id="formSection" class="form-section">
                <div class="form-inner">
                    <h2 class="form-title">Ingresa tus datos para participar</h2>
                    <form id="participantForm">
                        <div class="form-group">
                            <label for="name">Nombre completo</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Correo electrónico</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Teléfono</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                          <div class="form-group">
                            <input type="checkbox" id="subscribe" name="subscribe" style="width: auto; margin-right: 10px; vertical-align: middle;">
                            <label for="subscribe" style="display: inline; font-weight: normal; font-size: 16px;">Acepto recibir comunicaciones comerciales, promociones y ofertas personalizadas por medios electrónicos.</label>
                            <p style="font-size: 12px; color: #777; margin-top: 10px;">Los datos personales proporcionados serán tratados por TotalEnergies Marketing Puerto Rico Corp. con la finalidad de gestionar su solicitud. Puede ejercer sus derechos de acceso, rectificación, supresión y otros, según se detalla en nuestra Política de Privacidad.</p>
                        </div>
                        
                        <button type="submit" class="btn">¡Participar ahora!</button>
                    </form>
                </div>
            </div>
            
            <div id="wheelSection" class="wheel-section">
                <h2 class="form-title">¡Gira la Ruleta y Descubre Tu Premio!</h2>
                
                <div class="wheel-container">
                    <div class="wheel-indicator"></div>
                    <canvas id="wheel"></canvas>
                </div>
                
                <button id="spinBtn" class="btn spin-button">¡GIRAR!</button>
                
                <div id="result"></div>
                
                <img src="TotalEnergies_Logo_RGB_32.png" alt="TotalEnergies Logo" class="logo-below-wheel">
            </div>

            <div id="adminSection" class="admin-section">
                <h2 class="form-title">Panel de Administración</h2>

                <h3>Configuración General</h3>
                <div class="form-group">
                    <label for="adminCompanyLogoUrl">URL Logo Empresa (Header)</label>
                    <input type="file" id="adminCompanyLogoFile" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="adminRouletteLogoUrl">URL Logo Centro Ruleta</label>
                    <input type="file" id="adminRouletteLogoFile" accept="image/*">
                </div>
                <button id="saveAdminSettingsBtn" class="btn">Guardar Configuración</button>

                <h3>Gestión de Premios</h3>
                <form id="prizeForm">
                    <div class="form-group">
                        <label for="prizeTextAdmin">Nombre del Premio</label>
                        <input type="text" id="prizeTextAdmin" required>
                    </div>
                    <div class="form-group">
                        <label for="prizeColorAdmin">Color del Segmento</label>
                        <input type="color" id="prizeColorAdmin" value="#ff0000" required>
                    </div>
                    <div class="form-group">
                        <label for="prizeProbabilityAdmin">Probabilidad (peso)</label>
                        <input type="number" id="prizeProbabilityAdmin" min="1" value="10" required>
                    </div>
                    <div class="form-group">
                        <label for="prizeQuantityAdmin">Cantidad Disponible (0 para ilimitado)</label>
                        <input type="number" id="prizeQuantityAdmin" min="0" value="10" required>
                    </div>
                    <input type="hidden" id="prizeEditIndex">
                    <button type="submit" class="btn">Añadir/Actualizar Premio</button>
                </form>
                <h4>Listado de Premios</h4>
                <table id="prizesTable" class="admin-table">
                    <thead>
                        <tr>
                            <th>Premio</th>
                            <th>Color</th>
                            <th>Probabilidad</th>
                            <th>Cantidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <h3>Datos de Participantes</h3>
                <table id="participantsTable" class="admin-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Desea Recibir Información</th>
                            <th>Fecha</th>
                            <th>Premio Ganado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button id="exportCsvBtn" class="btn">Exportar a CSV</button>
                <button id="resetPrizesQuantityBtn" class="btn" style="background-color: #ff9800;">Resetear Cantidad Premios</button>
                <button id="clearParticipantsBtn" class="btn" style="background-color: #f44336;">Limpiar Participantes</button>
            </div>
        </div>
    </div>
    
    <div id="prizeModal" class="modal">
        <div class="modal-content">
            <h2 class="prize-title">¡Felicidades!</h2>
            <p id="prizeModalText" class="prize-text">Has ganado un premio increíble</p>
            <button id="closeModal" class="btn close-modal">Aceptar</button>
        </div>
    </div>

    <div id="passwordAdminModal" class="password-modal">
        <div class="password-modal-content">
            <h3>Acceso Administrador</h3>
            <label for="adminPasswordInput" style="display:block; margin-bottom:8px;">Contraseña:</label>
            <input type="password" id="adminPasswordInput">
            <div class="password-modal-buttons">
                <button id="submitAdminPassword" class="password-modal-submit">Ingresar</button>
                <button id="cancelAdminPassword" class="password-modal-cancel">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script>
        let participants = [];
        let prizes = [];

        // Roulette variables
        let canvasWheel, ctxWheel, wheelRadius, wheelCenterX, wheelCenterY, wheelSize;
        let isSpinning = false;
        let startAngle = 0;
        let currentRotationDegrees = 0;
        let targetRotationDegrees = 0;
        let selectedPrizeIndex = null;
        let rouletteCenterLogoImg = null;

        // Predefined wheel color scheme
        const wheelColors = ["#ff0000", "#285aff", "#009bff", "#32c8c8", "#28c896", "#808080", "#ffc800"]; // Updated dark gray for "Suerte en la próxima"

        const defaultPrizes = [
            { text: "¡Cambio de aceite Quartz gratis!", color: "#ff0000", probability: 10, quantity: 5, initialQuantity: 5 },
            { text: "¡Suerte en la próxima!", color: "#808080", probability: 20, quantity: 0, initialQuantity: 0 },
            { text: "US$20.00 de Combustible TE!", color: "#009bff", probability: 15, quantity: 10, initialQuantity: 10 },
            { text: "¡Gorra Quartz!", color: "#32c8c8", probability: 10, quantity: 15, initialQuantity: 15 },
            { text: "¡Camiseta Quartz!", color: "#28c896", probability: 10, quantity: 15, initialQuantity: 15 },
            { text: "US$50.00 de Combustible TE!", color: "#96e600", probability: 5, quantity: 5, initialQuantity: 5 },
            { text: "4 cuartos de Quartz!", color: "#ffc800", probability: 10, quantity: 10, initialQuantity: 10 },
            { text: "¡$US100.00 TE Gift Card!", color: "#285aff", probability: 5, quantity: 3, initialQuantity: 3 }
        ];

        // DOM Elements
        const participantForm = document.getElementById('participantForm');
        const formSection = document.getElementById('formSection');
        const wheelSection = document.getElementById('wheelSection');
        const spinBtn = document.getElementById('spinBtn');
        const resultDiv = document.getElementById('result');
        const prizeModal = document.getElementById('prizeModal');
        const prizeModalText = document.getElementById('prizeModalText');
        const closeModalBtn = document.getElementById('closeModal');
        
        const adminToggleBtn = document.getElementById('adminToggleBtn');
        const adminSection = document.getElementById('adminSection');
        const passwordAdminModal = document.getElementById('passwordAdminModal');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const submitAdminPasswordBtn = document.getElementById('submitAdminPassword');
        const cancelAdminPasswordBtn = document.getElementById('cancelAdminPassword');
        const wheelOnlyBtn = document.getElementById('wheelOnlyBtn'); // Ensure wheelOnlyBtn is defined
        
        let adminCompanyLogoFileInput;
        let adminRouletteLogoFileInput;

        const saveAdminSettingsBtn = document.getElementById('saveAdminSettingsBtn');
        const companyLogoElement = document.getElementById('companyLogo');

        const prizeForm = document.getElementById('prizeForm');
        const prizeTextAdminInput = document.getElementById('prizeTextAdmin');
        const prizeColorAdminInput = document.getElementById('prizeColorAdmin');
        const prizeProbabilityAdminInput = document.getElementById('prizeProbabilityAdmin');
        const prizeQuantityAdminInput = document.getElementById('prizeQuantityAdmin');
        const prizeEditIndexInput = document.getElementById('prizeEditIndex');
        const prizesTableBody = document.getElementById('prizesTable').getElementsByTagName('tbody')[0];
        
        const participantsTableBody = document.getElementById('participantsTable').getElementsByTagName('tbody')[0];
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const resetPrizesQuantityBtn = document.getElementById('resetPrizesQuantityBtn');
        const clearParticipantsBtn = document.getElementById('clearParticipantsBtn');

        // Idle timer variables
        let idleTimer = null;
        const IDLE_TIMEOUT_MS = 180000; // 3 minutes

        // Utility function for debouncing
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Toast Notification Function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 500);
            }, 3000);
        }

        // Global state variables
        let isWheelOnlyModeActive = false;
        let formSectionDisplayBeforeAdmin = 'block'; // Default initial state for form
        let wheelSectionDisplayBeforeAdmin = 'none'; // Default initial state for wheel

        // Setup listeners for idle detection
        function setupIdleListeners() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
            
            events.forEach(event => {
                document.addEventListener(event, resetIdleTimer, { passive: true });
            });
            
            resetIdleTimer();
        }

        // Reset the idle timer
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                const formSection = document.getElementById('formSection');
                
                if (formSection.style.display === 'none') {
                    showToast('Reiniciando por inactividad...', 'warning');
                    setTimeout(() => {
                        resetForm();
                        if (isSpinning) {
                            isSpinning = false;
                            if (canvasWheel) {
                                canvasWheel.style.transition = 'none';
                            }
                        }
                        formSection.style.display = 'block';                        const wheelOnlyBtn = document.getElementById('wheelOnlyBtn');
                        if (wheelOnlyBtn) {
                            wheelOnlyBtn.classList.remove('form-mode');
                        }
                        
                        const wheelSection = document.getElementById('wheelSection');
                        if (wheelSection) {
                            wheelSection.style.display = 'none';
                        }
                          setTimeout(() => {
                            if (typeof resizeWheel === 'function') {
                                resizeWheel();
                            }
                            if (typeof drawWheel === 'function') {
                                drawWheel();
                            }
                        }, window.innerWidth <= 768 ? 150 : 100);
                    }, 1500);
                }
            }, IDLE_TIMEOUT_MS);
        }

        // Initial listeners setup
        window.addEventListener('DOMContentLoaded', () => {
            loadPrizes(); // Load prizes first
            loadParticipants(); // Load participants

            initWheel(); // Initialize the wheel mechanics and drawing

            if (spinBtn) { // Add event listener for the spin button
                spinBtn.addEventListener('click', spinWheel);
            } else {
                console.error("Spin button not found. Spin functionality will not work.");
            }

            // Set initial view states
            if (formSection) formSection.style.display = 'block';
            if (wheelSection) wheelSection.style.display = 'none';
            if (adminSection) adminSection.style.display = 'none';
            
            renderPrizesTable(); // Populate admin prizes table
            renderParticipantsTable(); // Populate admin participants table

            isWheelOnlyModeActive = false; // Explicitly set initial mode
            if (wheelOnlyBtn) { // Assumes wheelOnlyBtn is defined
                wheelOnlyBtn.classList.remove('active');
                wheelOnlyBtn.addEventListener('click', toggleWheelOnlyMode);
            } else {
                console.warn('"wheelOnlyBtn" not found. The "Wh" button may not work.');
            }

            setupIdleListeners(); // Setup existing idle listeners
            resetIdleTimer();     // Start/reset the idle timer
        });
        
        closeModalBtn.addEventListener('click', () => {
            prizeModal.style.display = 'none';
            resetForm(); // Return to the form screen
        });

        // Function to toggle between form and wheel-only modes
        function toggleWheelOnlyMode() {
            resetIdleTimer();
            if (!formSection || !wheelSection || !adminSection) {
                console.error("Form, Wheel, or Admin section not found for toggleWheelOnlyMode.");
                return;
            }

            if (isWheelOnlyModeActive) {
                // Switch back to form mode (default view)
                formSection.style.display = 'block';
                wheelSection.style.display = 'none';
                adminSection.style.display = 'none'; // Ensure admin is hidden
                isWheelOnlyModeActive = false;
                if (wheelOnlyBtn) wheelOnlyBtn.classList.remove('active');
                // No need to redraw wheel if it's hidden
            } else {
                // Switch to wheel-only mode
                formSection.style.display = 'none';
                wheelSection.style.display = 'flex'; // Or 'block', depending on your CSS for .wheel-section
                adminSection.style.display = 'none'; // Ensure admin is hidden
                isWheelOnlyModeActive = true;
                if (wheelOnlyBtn) wheelOnlyBtn.classList.add('active');                // Ensure wheel is sized and drawn correctly with enhanced mobile delay
                const mobileDelay = window.innerWidth <= 768 ? 100 : 50;
                setTimeout(() => {
                    if (typeof resizeWheel === 'function') resizeWheel();
                    if (typeof drawWheel === 'function') drawWheel();
                }, mobileDelay);
            }
        }
        // Initialize wheel with High-DPI support
        function initWheel() {
            canvasWheel = document.getElementById('wheel');
            if (!canvasWheel) {
                console.error("Wheel canvas element not found");
                return;
            }
            
            ctxWheel = canvasWheel.getContext('2d');
            if (!ctxWheel) {
                console.error("Could not get wheel canvas context");
                return;
            }
            
            // Setup high DPI canvas
            const dpr = window.devicePixelRatio || 1;
            const rect = canvasWheel.getBoundingClientRect();
            canvasWheel.width = rect.width * dpr;
            canvasWheel.height = rect.height * dpr;
            canvasWheel.style.width = rect.width + 'px';
            canvasWheel.style.height = rect.height + 'px';
            ctxWheel.scale(dpr, dpr);
              // Load the center logo
            rouletteCenterLogoImg = new Image();            rouletteCenterLogoImg.onload = function() {
                drawWheel();
            };
            rouletteCenterLogoImg.onerror = function() {
                drawWheel();
            };
            
            try {
                const rouletteLogoDataUrl = localStorage.getItem('adminRouletteLogoDataUrl');
                if (rouletteLogoDataUrl) {
                    rouletteCenterLogoImg.src = rouletteLogoDataUrl;
                } else {
                    rouletteCenterLogoImg.src = 'QuartzLUBS-2.png';
                }
            } catch (e) {
                console.error("Error loading roulette logo from localStorage:", e);
                rouletteCenterLogoImg.src = 'QuartzLUBS-2.png';
            }            // Initial sizing
            resizeWheel();
              // Enhanced resize handler with debouncing
            window.addEventListener('resize', debouncedResizeHandler, { passive: true });
              // Force initial draw even if logo hasn't loaded yet
            setTimeout(() => {
                drawWheel();
            }, 100);
        }        // Enhanced resize function with size constraints
        function resizeWheel() {
            const container = document.querySelector('.wheel-container');
            if (!container || !canvasWheel) return;
            
            // Get container dimensions
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Get container padding to ensure wheel fits within the border
            const containerStyle = window.getComputedStyle(container);
            const paddingLeft = parseFloat(containerStyle.paddingLeft);
            const paddingRight = parseFloat(containerStyle.paddingRight);
            const paddingTop = parseFloat(containerStyle.paddingTop);
            const paddingBottom = parseFloat(containerStyle.paddingBottom);
            
            // Calculate available space inside the padding
            const availableWidth = containerWidth - paddingLeft - paddingRight;
            const availableHeight = containerHeight - paddingTop - paddingBottom;
            
            let wheelSize = Math.min(availableWidth, availableHeight);
            
            // Apply size constraints based on screen size
            const screenWidth = window.innerWidth;
            if (screenWidth <= 320) {
                wheelSize = Math.max(240, Math.min(wheelSize, 280));
            } else if (screenWidth <= 480) {
                wheelSize = Math.max(280, Math.min(wheelSize, 350));
            } else if (screenWidth <= 768) {
                wheelSize = Math.max(350, Math.min(wheelSize, 500));
            } else if (screenWidth <= 1200) {
                wheelSize = Math.max(400, Math.min(wheelSize, 600));
            } else if (screenWidth <= 1600) {
                wheelSize = Math.max(500, Math.min(wheelSize, 700));
            } else {
                wheelSize = Math.max(600, Math.min(wheelSize, 800));
            }
            
            // Update global wheelSize variable
            window.wheelSize = wheelSize;
            
            // Update canvas dimensions
            canvasWheel.style.width = `${wheelSize}px`;
            canvasWheel.style.height = `${wheelSize}px`;
            
            // Account for high-DPI displays
            const dpr = window.devicePixelRatio || 1;
            canvasWheel.width = wheelSize * dpr;
            canvasWheel.height = wheelSize * dpr;
            
            // Reset the context and scale only once
            ctxWheel.setTransform(1, 0, 0, 1, 0, 0); // Reset any existing transforms
            ctxWheel.scale(dpr, dpr);
            
            // Set wheel center coordinates
            wheelCenterX = wheelSize / 2;
            wheelCenterY = wheelSize / 2;
        }

        // Create debounced resize handler
        const debouncedResizeHandler = debounce(() => {
            resizeWheel();
            drawWheel();        }, 250);        function drawWheel() {
            if (!ctxWheel) {
                console.error("Canvas context not available");
                return;
            }
            
            if (prizes.length === 0) {
                return;
            }
            
            // Ensure wheelSize is properly set
            if (!window.wheelSize) {
                resizeWheel();
            }
            
            const radius = window.wheelSize / 2;
            const sliceAngle = (2 * Math.PI) / prizes.length;
            
            // Update wheel center coordinates
            wheelCenterX = window.wheelSize / 2;
            wheelCenterY = window.wheelSize / 2;
            
            ctxWheel.clearRect(0, 0, window.wheelSize, window.wheelSize);
            
            // Adaptive font sizing based on wheel size and screen
            const screenWidth = window.innerWidth;
            let baseFontSize = radius * 0.06;
            
            // Adjust font size for different screen sizes
            if (screenWidth <= 320) {
                baseFontSize = Math.max(10, radius * 0.08);
            } else if (screenWidth <= 480) {
                baseFontSize = Math.max(12, radius * 0.07);
            } else if (screenWidth <= 768) {
                baseFontSize = Math.max(14, radius * 0.065);
            }
            
            // Draw each slice of the wheel
            for (let i = 0; i < prizes.length; i++) {
                const startAngle = i * sliceAngle;
                const endAngle = (i + 1) * sliceAngle;
                
                ctxWheel.beginPath();
                ctxWheel.moveTo(wheelCenterX, wheelCenterY);
                ctxWheel.arc(wheelCenterX, wheelCenterY, radius, startAngle, endAngle);
                ctxWheel.closePath();
                
                // Use predefined wheel colors in sequence
                const colorIndex = i % wheelColors.length;
                ctxWheel.fillStyle = wheelColors[colorIndex];
                ctxWheel.fill();
                
                ctxWheel.lineWidth = 2;
                ctxWheel.strokeStyle = '#FFFFFF';
                ctxWheel.stroke();
                
                // Add prize text with adaptive sizing
                ctxWheel.save();
                ctxWheel.translate(wheelCenterX, wheelCenterY);
                ctxWheel.rotate(startAngle + sliceAngle / 2);
                
                ctxWheel.textAlign = 'right';
                ctxWheel.textBaseline = 'middle';
                ctxWheel.fillStyle = '#FFFFFF';
                ctxWheel.font = `bold ${baseFontSize}px Arial`;
                ctxWheel.shadowColor = 'rgba(0,0,0,0.5)';
                ctxWheel.shadowBlur = 3;
                ctxWheel.shadowOffsetX = 1;
                ctxWheel.shadowOffsetY = 1;
                
                const textRadius = radius * 0.8;
                let maxTextWidth = radius * 0.5;
                
                // Adjust text width for smaller screens
                if (screenWidth <= 480) {
                    maxTextWidth = radius * 0.45;
                }
                
                // Enhanced text wrapping function
                function wrapText(context, text, x, y, maxWidth, lineHeight) {
                    const words = text.split(' ');
                    let line = '';
                    let testLine = '';
                    let metrics;
                    let testWidth;

                    for (let n = 0; n < words.length; n++) {
                        testLine = line + words[n] + ' ';
                        metrics = context.measureText(testLine);
                        testWidth = metrics.width;
                        if (testWidth > maxWidth && n > 0) {
                            context.fillText(line.trim(), x, y);
                            line = words[n] + ' ';
                            y += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    if (line.trim()) {
                        context.fillText(line.trim(), x, y);
                    }
                }
                
                // Adaptive line height
                const lineHeight = Math.max(baseFontSize * 1.2, radius * 0.07);
                wrapText(ctxWheel, prizes[i].text, textRadius, 0, maxTextWidth, lineHeight);
                
                ctxWheel.restore();
            }
            
            // Draw center circle
            ctxWheel.beginPath();
            ctxWheel.arc(wheelCenterX, wheelCenterY, radius * 0.2, 0, 2 * Math.PI);
            ctxWheel.fillStyle = '#FFFFFF';
            ctxWheel.fill();
            ctxWheel.strokeStyle = '#FFFFFF00';
            ctxWheel.lineWidth = 3;
            ctxWheel.stroke();
            
            // Draw center logo with adaptive sizing
            if (rouletteCenterLogoImg && rouletteCenterLogoImg.complete) {
                let logoSize = radius * 0.18;
                
                // Adjust logo size for very small screens
                if (screenWidth <= 320) {
                    logoSize = radius * 0.15;
                } else if (screenWidth <= 480) {
                    logoSize = radius * 0.16;
                }
                
                ctxWheel.save();
                ctxWheel.beginPath();
                ctxWheel.arc(wheelCenterX, wheelCenterY, logoSize, 0, Math.PI * 2, true);
                ctxWheel.closePath();
                ctxWheel.clip();
                
                ctxWheel.drawImage(
                    rouletteCenterLogoImg,
                    wheelCenterX - logoSize, 
                    wheelCenterY - logoSize,
                    logoSize * 2, 
                    logoSize * 2
                );
                ctxWheel.restore();
            }
            
            // Draw wheel pointer
            ctxWheel.beginPath();
            ctxWheel.moveTo(wheelCenterX, wheelCenterY - radius - 10);
            ctxWheel.lineTo(wheelCenterX - 15, wheelCenterY - radius + 20);
            ctxWheel.lineTo(wheelCenterX + 15, wheelCenterY - radius + 20);
            ctxWheel.closePath();
            ctxWheel.fillStyle = '#ff0000';
            ctxWheel.fill();
            ctxWheel.strokeStyle = '#FFFFFF';
            ctxWheel.lineWidth = 2;
            ctxWheel.stroke();
        }// Admin Panel Toggle with password
        adminToggleBtn.addEventListener('click', function() {
            if (adminSection.style.display === 'none' || adminSection.style.display === '') {
                // Store current states before showing admin panel
                formSectionDisplayBeforeAdmin = formSection.style.display;
                wheelSectionDisplayBeforeAdmin = wheelSection.style.display;
                
                // Show password modal
                passwordAdminModal.style.display = 'flex';
                adminPasswordInput.value = '';
                adminPasswordInput.focus();
            } else {
                // Hide admin panel and restore previous view
                adminSection.style.display = 'none';
                if(adminToggleBtn) adminToggleBtn.classList.remove('active');
                
                // Restore the previous state based on stored values
                formSection.style.display = formSectionDisplayBeforeAdmin;
                wheelSection.style.display = wheelSectionDisplayBeforeAdmin;                // If wheel was supposed to be visible, redraw it with enhanced mobile delay
                if (wheelSectionDisplayBeforeAdmin === 'flex' || wheelSectionDisplayBeforeAdmin === 'block') {
                    const mobileDelay = window.innerWidth <= 768 ? 100 : 50;
                    setTimeout(() => {
                        if (typeof resizeWheel === 'function') resizeWheel();
                        if (typeof drawWheel === 'function') drawWheel();
                    }, mobileDelay);
                }
                resetIdleTimer();
            }
        });        submitAdminPasswordBtn.addEventListener('click', () => {
            const password = adminPasswordInput.value;
            if (password === "WW@TE2025") {
                passwordAdminModal.style.display = 'none';
                
                // Show admin panel and hide others
                adminSection.style.display = 'block';
                formSection.style.display = 'none';
                wheelSection.style.display = 'none';
                
                // Update admin button visual state
                adminToggleBtn.classList.add('active');
                
                showToast("Panel de administración desbloqueado", "success");
            } else {
                showToast("Contraseña incorrecta.", "error");
                adminPasswordInput.value = '';
                adminPasswordInput.focus();
            }
        });

        adminPasswordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitAdminPasswordBtn.click();
            }
        });        cancelAdminPasswordBtn.addEventListener('click', () => {
            passwordAdminModal.style.display = 'none';
            // Restore the view that was active before trying to open admin
            formSection.style.display = formSectionDisplayBeforeAdmin;
            wheelSection.style.display = wheelSectionDisplayBeforeAdmin;
            if (wheelSectionDisplayBeforeAdmin === 'flex' || wheelSectionDisplayBeforeAdmin === 'block') {
                const mobileDelay = window.innerWidth <= 768 ? 100 : 50;
                setTimeout(() => {
                    if (typeof resizeWheel === 'function') resizeWheel();
                    if (typeof drawWheel === 'function') drawWheel();
                }, mobileDelay);
            }
            resetIdleTimer();
        });        window.addEventListener('click', (event) => {
            if (event.target == passwordAdminModal) {
                passwordAdminModal.style.display = 'none';
                // Restore the view
                formSection.style.display = formSectionDisplayBeforeAdmin;
                wheelSection.style.display = wheelSectionDisplayBeforeAdmin;
                if (wheelSectionDisplayBeforeAdmin === 'flex' || wheelSectionDisplayBeforeAdmin === 'block') {
                    const mobileDelay = window.innerWidth <= 768 ? 100 : 50;
                    setTimeout(() => {
                        if (typeof resizeWheel === 'function') resizeWheel();
                        if (typeof drawWheel === 'function') drawWheel();
                    }, mobileDelay);
                }
                resetIdleTimer();
            }
            if (event.target == prizeModal) {
                prizeModal.style.display = 'none';
            }
        });

        // Save Admin Settings
        saveAdminSettingsBtn.addEventListener('click', () => {
            try {
                showToast('Configuración guardada!');
            } catch (e) {
                console.error("Error saving admin settings:", e);
                showToast('Error al guardar configuración.', 'error');
            }
        });

        // Handle Company Logo Upload
        function handleCompanyLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        localStorage.setItem('adminCompanyLogoDataUrl', e.target.result);
                        companyLogoElement.src = e.target.result;
                        companyLogoElement.style.display = 'inline-block';
                        showToast('Logo de empresa actualizado.');
                    } catch (err) {
                        console.error("Error saving company logo:", err);
                        showToast('Error al guardar logo de empresa.', 'error');
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // Handle Roulette Logo Upload
        function handleRouletteLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        localStorage.setItem('adminRouletteLogoDataUrl', e.target.result);
                        rouletteCenterLogoImg = new Image();
                        rouletteCenterLogoImg.onload = () => {
                            drawWheel();
                            showToast('Logo de ruleta actualizado.');
                        };
                        rouletteCenterLogoImg.onerror = () => {
                            rouletteCenterLogoImg = null;
                            drawWheel();
                            showToast('Error al cargar imagen de logo para ruleta.', 'error');
                        };
                        rouletteCenterLogoImg.src = e.target.result;
                    } catch (err) {
                        console.error("Error saving roulette logo:", err);
                        showToast('Error al guardar logo de ruleta.', 'error');
                    }
                }
                reader.readAsDataURL(file);
            }
        }
        
        // Prize Management
        prizeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = prizeTextAdminInput.value.trim();
            const color = prizeColorAdminInput.value;
            const probability = parseInt(prizeProbabilityAdminInput.value);
            const quantity = parseInt(prizeQuantityAdminInput.value);
            const editIndex = prizeEditIndexInput.value;

            if (!text || probability <= 0) {
                showToast("Por favor, completa el nombre del premio y asegúrate que la probabilidad sea mayor a 0.", "warning");
                return;
            }

            const newPrize = { text, color, probability, quantity, initialQuantity: quantity };

            if (editIndex === "") {
                prizes.push(newPrize);
            } else {
                prizes[parseInt(editIndex)] = newPrize;
            }
            
            savePrizes();
            renderPrizesTable();
            drawWheel(); 
            prizeForm.reset();
            prizeColorAdminInput.value = "#ff0000";
            prizeQuantityAdminInput.value = "10";
            prizeProbabilityAdminInput.value = "10";
            prizeEditIndexInput.value = "";
            showToast("Premio guardado correctamente.");
        });

        function renderPrizesTable() {
            prizesTableBody.innerHTML = ""; 
            prizes.forEach((prize, index) => {
                const row = prizesTableBody.insertRow();
                row.insertCell().textContent = prize.text;
                
                const colorCell = row.insertCell();
                colorCell.style.backgroundColor = prize.color;
                const textColor = getContrastYIQ(prize.color);
                colorCell.style.color = textColor;
                colorCell.textContent = prize.color;

                row.insertCell().textContent = prize.probability;
                row.insertCell().textContent = prize.quantity === 0 ? "Ilimitado" : `${prize.quantity}/${prize.initialQuantity}`;
                
                const actionsCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Editar';
                editBtn.classList.add('btn', 'action-btn');
                editBtn.onclick = () => editPrize(index);
                actionsCell.appendChild(editBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Eliminar';
                deleteBtn.classList.add('btn', 'action-btn');
                deleteBtn.style.backgroundColor = '#f44336';
                deleteBtn.onclick = () => deletePrize(index);
                actionsCell.appendChild(deleteBtn);
            });
        }
        
        function getContrastYIQ(hexcolor){
            hexcolor = hexcolor.replace("#", "");
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        function editPrize(index) {
            const prize = prizes[index];
            prizeTextAdminInput.value = prize.text;
            prizeColorAdminInput.value = prize.color;
            prizeProbabilityAdminInput.value = prize.probability;
            prizeQuantityAdminInput.value = prize.quantity;
            prizeEditIndexInput.value = index;
            prizeTextAdminInput.focus();
        }

        function deletePrize(index) {
            if (confirm(`¿Seguro que quieres eliminar el premio "${prizes[index].text}"?`)) {
                prizes.splice(index, 1);
                savePrizes();
                renderPrizesTable();
                drawWheel();
                showToast("Premio eliminado correctamente.");
            }
        }
        
        function savePrizes() {
            try {
                localStorage.setItem('roulettePrizes', JSON.stringify(prizes));
            } catch (e) {
                console.error("Error saving prizes:", e);
                showToast('Error al guardar premios.', 'error');
            }
        }        function loadPrizes() {
            try {
                const storedPrizes = localStorage.getItem('roulettePrizes');
                if (storedPrizes) {
                    prizes = JSON.parse(storedPrizes);
                    prizes.forEach(p => {
                        if (p.initialQuantity === undefined) {
                            p.initialQuantity = p.quantity;
                        }
                    });
                } else {
                    prizes = JSON.parse(JSON.stringify(defaultPrizes));
                }
                
                // Ensure we have at least one prize if something went wrong
                if (!prizes || prizes.length === 0) {
                    prizes = JSON.parse(JSON.stringify(defaultPrizes));
                    savePrizes(); // Save the default prizes
                }
            } catch (e) {
                console.error("Error loading prizes:", e);
                prizes = JSON.parse(JSON.stringify(defaultPrizes));
                savePrizes(); // Save the default prizes
            }
        }

        // Participant Data Management
        function renderParticipantsTable() {
            participantsTableBody.innerHTML = "";
            participants.forEach(p => {
                const row = participantsTableBody.insertRow();
                row.insertCell().textContent = p.name;
                row.insertCell().textContent = p.email;
                row.insertCell().textContent = p.phone;
                row.insertCell().textContent = p.subscribe ? 'Sí' : 'No';
                row.insertCell().textContent = new Date(p.date).toLocaleString();
                row.insertCell().textContent = p.prize || "N/A";
            });
        }

        function saveParticipants() {
            try {
                localStorage.setItem('rouletteParticipants', JSON.stringify(participants));
            } catch (e) {
                console.error("Error saving participants:", e);
                showToast('Error al guardar datos de participante.', 'error');
            }
        }

        function loadParticipants() {
            try {
                const storedParticipants = localStorage.getItem('rouletteParticipants');
                if (storedParticipants) {
                    participants = JSON.parse(storedParticipants);
                }
            } catch (e) {
                console.error("Error loading participants:", e);
                participants = [];
            }
        }
        
        clearParticipantsBtn.addEventListener('click', () => {
            if (confirm("¿Seguro que quieres eliminar todos los datos de los participantes? Esta acción no se puede deshacer.")) {
                participants = [];
                saveParticipants();
                renderParticipantsTable();
                showToast("Datos de participantes eliminados.");
            }
        });

        exportCsvBtn.addEventListener('click', () => {
            if (participants.length === 0) {
                showToast("No hay participantes para exportar", "warning");
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nombre,Correo Electrónico,Teléfono,Desea Recibir Información,Fecha,Premio Ganado\r\n";
            participants.forEach(p => {
                const dateFormatted = new Date(p.date).toLocaleString();
                const prizeWon = p.prize || "N/A";
                const subscribed = p.subscribe ? 'Sí' : 'No';
                let row = `"${p.name}","${p.email}","${p.phone}","${subscribed}","${dateFormatted}","${prizeWon}"`;
                csvContent += row + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "participantes_ruleta.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });        // Form Submission 
        participantForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const subscribe = document.getElementById('subscribe').checked;
            
            if (!name || !email || !phone) {
                showToast("Por favor, complete todos los campos del formulario.", "warning");
                return;
            }
            
            // Add the participant to the list
            const participant = {
                id: Date.now(),
                name, 
                email, 
                phone,
                subscribe,
                date: new Date().toISOString(),
                prize: null
            };
            
            participants.push(participant);
            saveParticipants();
            renderParticipantsTable();
            
            // Clear the form
            participantForm.reset();
            
            // Show loading message
            showToast("Cargando ruleta...", "info");
            
            // Direct transition to wheel view
            formSection.style.display = 'none';
            adminSection.style.display = 'none'; // Ensure admin is also hidden
            wheelSection.style.display = 'flex'; // Or 'block'
            
            isWheelOnlyModeActive = false; // Not in explicit wheel-only mode
            if(wheelOnlyBtn) wheelOnlyBtn.classList.remove('active'); // Deactivate Wh button            // Size and draw the wheel with enhanced mobile delay
            const mobileDelay = window.innerWidth <= 768 ? 100 : 50;
            setTimeout(() => {
                if (typeof resizeWheel === 'function') resizeWheel();
                if (typeof drawWheel === 'function') drawWheel();
            }, mobileDelay);
            
            // Show success message
            showToast("¡Datos registrados correctamente! Ahora puedes girar la ruleta.", "success");
            
            // Reset idle timer
            resetIdleTimer();
        });
        
        // Spin the wheel function
        function spinWheel() {
            if (isSpinning) return;

            // Corrected filter for available prizes
            const availablePrizes = prizes.filter(p => p.initialQuantity === 0 || p.quantity > 0);
            if (availablePrizes.length === 0) {
                showToast("¡Todos los premios se han agotado!", "warning");
                resultDiv.textContent = "No quedan premios.";
                return;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            resultDiv.textContent = "Girando...";

            const totalProbability = availablePrizes.reduce((sum, prize) => sum + prize.probability, 0);
            let randomValue = Math.random() * totalProbability;
            
            let cumulativeProbability = 0;
            selectedPrizeIndex = -1;
            let actualPrizeArrayIndex = -1; 

            for (let i = 0; i < availablePrizes.length; i++) {
                cumulativeProbability += availablePrizes[i].probability;
                if (randomValue <= cumulativeProbability) {
                    selectedPrizeIndex = prizes.indexOf(availablePrizes[i]); 
                    actualPrizeArrayIndex = i;
                    break;
                }
            }

            if (selectedPrizeIndex === -1) { 
                selectedPrizeIndex = prizes.indexOf(availablePrizes[availablePrizes.length - 1]);
                actualPrizeArrayIndex = availablePrizes.length - 1;
            }
            
            const prize = prizes[selectedPrizeIndex]; 

            const numSegments = availablePrizes.length;
            const segmentAngleDegrees = 360 / numSegments;
            
            // Calculate the angle to the middle of the selected segment (0 degrees is at 3 o'clock).
            let targetAngleForSelectedSegment = (actualPrizeArrayIndex + 0.5) * segmentAngleDegrees;
            
            // Adjust for 12 o'clock pointer position.
            // The 12 o'clock position is at 270 degrees in canvas coordinates (where 0 is 3 o'clock).
            // The wheel rotates clockwise. `targetRotationDegrees` is the final absolute rotation.
            // A feature at angle `A` on the wheel appears at `A - targetRotationDegrees` in the canvas frame.
            // We want `targetAngleForSelectedSegment - (targetRotationDegrees % 360)` to be `270`.
            // So, `(targetRotationDegrees % 360) = targetAngleForSelectedSegment - 270`.
            // Revision: If wheel rotates R clockwise, a feature at A_wheel (clockwise) on wheel is now at (R + A_wheel) in page coords.
            // We want (targetRotationDegrees % 360) + targetAngleForSelectedSegment = 270 (pointer).
            // So, (targetRotationDegrees % 360) = 270 - targetAngleForSelectedSegment.
            let finalAngleMod360 = (270 - targetAngleForSelectedSegment + 360) % 360;
            
            const randomSpins = 5 + Math.floor(Math.random() * 5); // Number of full rotations
            const totalExtraRotation = randomSpins * 360;

            // Calculate the new target rotation.
            // It starts from the current rotation's base (stripping full circles), adds full random spins, and then the final angle.
            let newTargetRotationDegrees = currentRotationDegrees - (currentRotationDegrees % 360) + totalExtraRotation + finalAngleMod360;

            // Ensure the wheel spins forward by a noticeable amount, at least one more full rotation if the target is too close.
            if (newTargetRotationDegrees <= currentRotationDegrees + segmentAngleDegrees) { 
                 newTargetRotationDegrees += 360 * (1 + Math.floor(Math.random()*2)); // Add 1 to 2 more full spins
            }
            
            targetRotationDegrees = newTargetRotationDegrees;
            const spinDuration = 5; // seconds

            if (canvasWheel) {
                canvasWheel.style.transition = `transform ${spinDuration + 2}s cubic-bezier(0.25, 0.1, 0.25, 1)`;                
                void canvasWheel.offsetHeight;

                requestAnimationFrame(() => {
                    canvasWheel.style.transform = `rotate(${targetRotationDegrees}deg)`;
                });

                const onSpinEndHandler = () => {
                    isSpinning = false;
                    spinBtn.disabled = false;
                    currentRotationDegrees = targetRotationDegrees;

                    resultDiv.textContent = `¡Has ganado: ${prize.text}!`;


                    prizeModalText.textContent = `¡Has ganado: ${prize.text}!`;
                    prizeModal.style.display = 'flex';
                    createConfetti();
                    triggerFireworks();

                    // Update prize quantity
                    if (prize.initialQuantity !== 0 && prize.quantity > 0) { // Check initialQuantity for limited prizes
                        prize.quantity--;
                        savePrizes();
                        renderPrizesTable(); // This will re-render table
                        // drawWheel(); // drawWheel will be called if needed, e.g. by renderPrizesTable if it affects wheel appearance
                    }
                    
                    if (participants.length > 0) {
                        const lastParticipant = participants[participants.length - 1];
                        lastParticipant.prize = prize.text; 
                        saveParticipants();
                        renderParticipantsTable();
                    }
                    
                    canvasWheel.removeEventListener('transitionend', onSpinEndHandler);
                    canvasWheel.style.transition = 'none';
                };
                
                canvasWheel.addEventListener('transitionend', onSpinEndHandler);
            } else {
                console.error("Wheel canvas element not found for spinning.");
                isSpinning = false;
                spinBtn.disabled = false;
                resultDiv.textContent = "Error al girar.";
                showToast("Error al girar la ruleta", "error");
            }
        }

        // Helper function to wrap text for wheel segments
        function wrapTextForWheel(context, text, maxWidth) {
            const words = text.split(' ');
            if (words.length === 0) return [];
            let lines = [];
            let currentLine = words[0] || "";

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const testLine = currentLine + " " + word;
                if (context.measureText(testLine).width < maxWidth) {
                    currentLine = testLine;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            if (currentLine) { // Ensure last line is pushed if not empty
                lines.push(currentLine);
            }
            return lines;
        }

        function createConfetti() {
            const confettiCount = 200;
            const confettiContainer = document.body;
            for (let i = 0; i < confettiCount; i++) {
                const confettiPiece = document.createElement('div');
                confettiPiece.classList.add('confetti');
                confettiPiece.style.left = Math.random() * 100 + 'vw';
                confettiPiece.style.top = Math.random() * -50 + 'vh';
                
                // Use the wheel colors for confetti
                const colorIndex = Math.floor(Math.random() * wheelColors.length);
                confettiPiece.style.backgroundColor = wheelColors[colorIndex];
                
                confettiPiece.style.animationDuration = (Math.random() * 4 + 8) + 's';
                confettiPiece.style.animationDelay = Math.random() * 1 + 's';
                confettiPiece.style.transform = `rotate(${Math.random() * 360}deg) scale(${Math.random() * 0.5 + 0.5})`;
                confettiContainer.appendChild(confettiPiece);
                
                setTimeout(() => {
                    confettiPiece.remove();
                }, 12000);
            }
        }

        function triggerFireworks() {
            const fireworkCount = 30;

            for (let i = 0; i < fireworkCount; i++) {
                const numParticles = 30 + Math.floor(Math.random() * 20);
                
                const burstX = Math.random() * window.innerWidth;
                const burstY = Math.random() * window.innerHeight;

                for (let j = 0; j < numParticles; j++) {
                    const particle = document.createElement('div');
                    particle.classList.add('firework-particle');
                    
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * 100 + 50;
                    const translateX = Math.cos(angle) * distance;
                    const translateY = Math.sin(angle) * distance - (Math.random() * 30 + 20);

                    particle.style.setProperty('--translateX', `${translateX}px`);
                    particle.style.setProperty('--translateY', `${translateY}px`);
                    particle.style.left = `${burstX}px`;
                    particle.style.top = `${burstY}px`;
                    
                    // Use the wheel colors for fireworks
                    const colorIndex = Math.floor(Math.random() * wheelColors.length);
                    particle.style.backgroundColor = wheelColors[colorIndex];

                    document.body.appendChild(particle);

                    setTimeout(() => {
                        particle.remove();
                    }, 4000);
                }
            }
        }        function resetForm() {
            if(participantForm) {
                participantForm.reset();
            }
            
            formSection.style.display = 'block';
            wheelSection.style.display = 'none';
            adminSection.style.display = 'none';
            if(resultDiv) resultDiv.textContent = '';
            
            // Reset the wheel animation state if needed
            if (canvasWheel) {
                canvasWheel.style.transition = 'none';
                currentRotationDegrees = currentRotationDegrees % 360;
                canvasWheel.style.transform = `rotate(${currentRotationDegrees}deg)`;
            }
            
            // Make sure spinning is re-enabled
            isSpinning = false;
            if (spinBtn) {
                spinBtn.disabled = false;
            }
            isWheelOnlyModeActive = false; // Reset wheel-only mode state
            if(wheelOnlyBtn) wheelOnlyBtn.classList.remove('active'); // Deactivate Wh button
            resetIdleTimer();
        }
    </script>
</body>
</html>